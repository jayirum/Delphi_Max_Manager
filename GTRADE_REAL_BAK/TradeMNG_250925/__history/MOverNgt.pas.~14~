unit MOverNgt;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, RzLstBox, bsSkinCtrls, VCL_Helper, MBasic, DBGridEhGrouping,
  ToolCtrlsEh, DBGridEhToolCtrls, DynVarsEh, GridsEh, DBAxisGridsEh, DBGridEh,
  RzDBEdit, kcRaizeCtrl, StdCtrls, RzCmboBx, RzDBCmbo, RzSplit, Mask, RzEdit,
  bsMessages, DB, MemDS, DBAccess, Uni, ImgList, BusinessSkinForm, RzDBNav,
  bsribbon, ExtCtrls, RzPanel, math;

type
  TfmOverNgt = class(TfmBasic)
    gdMain: TDBGridEh;
    pnCnt: TRzPanel;
    bsSkinSpeedButton1: TbsSkinSpeedButton;
    bsSkinSpeedButton2: TbsSkinSpeedButton;
    dbMainUSER_ID: TStringField;
    dbMainUSER_NM: TStringField;
    dbMainARTC_CD: TStringField;
    dbMainSTK_CD: TStringField;
    dbMainOVERNGT_YN: TStringField;
    dbMainACNT_AMT: TFloatField;
    dbMainBS_TP: TStringField;
    dbMainNCLR_POS_QTY: TIntegerField;
    dbMainAVG_PRC: TFloatField;
    dbMainCNTR_PRC: TFloatField;
    dbMainEVA_PL: TFloatField;
    dbMainAVGPRC: TStringField;
    dbMainACNT_NO: TStringField;
    procedure btnExcelClick(Sender: TObject);
    procedure gdMainTitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
    procedure dbMainCalcFields(DataSet: TDataSet);
    procedure gdMainColumns6AdvDrawDataCell(Sender: TCustomDBGridEh; Cell,
      AreaCell: TGridCoord; Column: TColumnEh; const ARect: TRect;
      var Params: TColCellParamsEh; var Processed: Boolean);
    procedure gdMainColumns9AdvDrawDataCell(Sender: TCustomDBGridEh; Cell,
      AreaCell: TGridCoord; Column: TColumnEh; const ARect: TRect;
      var Params: TColCellParamsEh; var Processed: Boolean);
    procedure bsSkinSpeedButton2Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure MainTableOpen; override;
    procedure Send_NM003(sMsg: String);
  end;

var
  fmOverNgt: TfmOverNgt;

implementation

uses StdUtils, MMastDB, MDelay, PacketStruct;

{$R *.dfm}

{ TfmSample }

procedure TfmOverNgt.bsSkinSpeedButton2Click(Sender: TObject);
var
	sSQL, sMsg, sUserID, sUserNM, sArtcCD: String;
begin
  with dbMain do
  begin
  	sUserID := FieldByName('USER_ID').AsString;
    sUserNM := FieldByName('USER_NM').AsString;
    sArtcCD := FieldByName('ARTC_CD').AsString;

    if sUserID = '' then
    begin
      bsMsgError('회원을 먼저 선택하세요.');
      Exit;
    end;

    if bsMsgYesNo(Format('%s (%s) - %s 오버나잇을 취소하시겠습니까?', [sUserID, sUserNM, sArtcCD])) = False then
    begin
     	Exit;
    end;

    sSQL := Format('EXEC PT_RSLT_OVERNGT %s, %s, %s, %s, %s, %s',
                    [QuotedStr(sUserID),
                     QuotedStr(__Trade_DT),
                     QuotedStr('N'),
                     QuotedStr(FieldByName('ACNT_NO').AsString),
                     QuotedStr(sArtcCD),
                     QuotedStr(__Login_ID)
                    ]
                  );

    sMsg := Format('[ %s ]종목 오버나잇 취소되었습니다.', [FieldByName('STK_CD').AsString]);
  end;

	with MastDB.dbSQL do
  begin
		SQL.Text := sSQL;
    ExecSQL;
  end;

  Send_NM003(sMsg);

  MainTableOpen;
end;

procedure TfmOverNgt.btnExcelClick(Sender: TObject);
begin
  inherited;
  Export_Excel(gdMain);
end;

procedure TfmOverNgt.dbMainCalcFields(DataSet: TDataSet);
begin
  with DataSet do
  begin
    FieldByName('AVGPRC').AsString  := FormatFloat('###0.#######', FieldByName('AVG_PRC').AsFloat);
  end;
end;

procedure TfmOverNgt.gdMainColumns6AdvDrawDataCell(Sender: TCustomDBGridEh;
  Cell, AreaCell: TGridCoord; Column: TColumnEh; const ARect: TRect;
  var Params: TColCellParamsEh; var Processed: Boolean);
begin
  inherited;
	with TDBGridEh(Sender).DataSource.DataSet do
  begin
  	Sender.Canvas.Font.Color := clBlack;
	  if FieldByName(Column.FieldName).AsString = '매수' then Sender.Canvas.Font.Color := clRed
  	else if FieldByName(Column.FieldName).AsString = '매도' then Sender.Canvas.Font.Color := clBlue;

    Sender.DefaultDrawColumnDataCell(Cell, AreaCell, Column, ARect, Params);
    Processed := True;
  end;
end;

procedure TfmOverNgt.gdMainColumns9AdvDrawDataCell(Sender: TCustomDBGridEh;
  Cell, AreaCell: TGridCoord; Column: TColumnEh; const ARect: TRect;
  var Params: TColCellParamsEh; var Processed: Boolean);
begin
	with TDBGridEh(Sender).DataSource.DataSet do
  begin
  	Sender.Canvas.Font.Color := clBlack;
	  if CompareValue(FieldByName(Column.FieldName).AsFloat, 0) > 0 then Sender.Canvas.Font.Color := clRed
  	else if CompareValue(FieldByName(Column.FieldName).AsFloat, 0) < 0 then Sender.Canvas.Font.Color := clBlue;

    Sender.DefaultDrawColumnDataCell(Cell, AreaCell, Column, ARect, Params);
    Processed := True;
  end;
end;

procedure TfmOverNgt.gdMainTitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  inherited;
  with dbMain do
  begin
    if IndexFieldNames = Column.FieldName then IndexFieldNames := Column.FieldName + ' Desc'
    else IndexFieldNames := Column.FieldName
  end;
end;

procedure TfmOverNgt.MainTableOpen;
var
  sSql, sTp : String;
begin
  try
    Delay_Show();

    sSql := Format( 'SELECT A.USER_ID, ' +
                           'D.USER_NM, ' +
                           'A.ACNT_NO, ' +
                           'A.ARTC_CD, ' +
                           'B.STK_CD, ' +
                           'A.OVERNGT_YN, ' +
                           'C.CNTR_PRC, ' +
                           'D.ACNT_AMT + D.CLR_PL - D.CMSN AS ACNT_AMT, ' +
                           'CASE WHEN B.BS_TP = %s THEN %s ELSE %s END AS BS_TP, ' +
                           'B.NCLR_POS_QTY, ' +
                           'B.AVG_PRC, ' +
                           'CASE WHEN (A.ARTC_CD = %s OR A.ARTC_CD = %s) THEN ' +
                                'CASE WHEN B.BS_TP = %s THEN (B.AVG_PRC - C.CNTR_PRC) * B.NCLR_POS_QTY * (E.TICK_VALUE_LOW / E.TICK_SIZE_LOW) / F.LEVERAGE ' +
                                'ELSE (C.CNTR_PRC - B.AVG_PRC) * B.NCLR_POS_QTY * (E.TICK_VALUE_LOW / E.TICK_SIZE_LOW) / F.LEVERAGE END ' +
                           'ELSE ' +
                                'CASE WHEN B.BS_TP = %s THEN (B.AVG_PRC - C.CNTR_PRC) * B.NCLR_POS_QTY * (E.TICK_VALUE / E.TICK_SIZE) / F.LEVERAGE ' +
                                'ELSE (C.CNTR_PRC - B.AVG_PRC) * B.NCLR_POS_QTY * (E.TICK_VALUE / E.TICK_SIZE) / F.LEVERAGE END ' +
                           'END AS EVA_PL ' +
                      'FROM OVERNGT A, NCLR_POS B, CURR_PRC C, ACNT_MST D, ARTC_MST E, ACNT_MST F ' +
                     'WHERE A.ACNT_NO = B.ACNT_NO ' +
                       'AND A.ACNT_NO = D.ACNT_NO ' +
                       'AND A.ARTC_CD = B.ARTC_CD ' +
                       'AND B.STK_CD = C.STK_CD ' +
                       'AND A.ACNT_NO = F.ACNT_NO ' +
                       'AND (C.NGT_YN = %s OR ' +
                            'C.NGT_YN = (SELECT CASE WHEN MKT_TP >= 3 THEN %s ELSE %s END FROM ARTC_MST WHERE ARTC_CD = %s)) ' +
                       'AND A.ARTC_CD = E.ARTC_CD ' +
                       'AND A.OVERNGT_YN = %s ' +
                  'ORDER BY A.USER_ID ',
                    [QuotedStr('S'),
                     QuotedStr('매도'),
                     QuotedStr('매수'),
                     QuotedStr('201'),
                     QuotedStr('301'),
                     QuotedStr('S'),
                     QuotedStr('S'),
                     QuotedStr('A'),
                     QuotedStr('Y'),
                     QuotedStr('N'),
                     QuotedStr('101'),
                     QuotedStr('Y')
                    ]);

    Uni_Open(dbMain, sSql);

//    PartTableOpen(TComponent(gdMain.Columns[2]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));

    pnCnt.Caption := FormatFloat('#,##0건', dbMain.RecordCount);

  finally
    Delay_Hide;
  end;
end;

procedure TfmOverNgt.Send_NM003(sMsg: String);
var
  NM003  : TNM003;
  sValue : String;
begin
  FillChar(NM003, SizeOf(NM003), ' ');
  StrToArr(NumToStr(SizeOf(NM003)),                            NM003.GT_HEADER.LENGTH);
  StrToArr('NM003',                                            NM003.GT_HEADER.PACKET_CD);
  StrToArr(UpperCase(dbMain.FieldByName('USER_ID').AsString),  NM003.GT_HEADER.USER_ID);
  StrToArr('0',                                                NM003.GT_HEADER.ACNT_TP);
  StrToArr('0000',                                             NM003.GT_HEADER.ERR_CODE);
  StrToArr(NowMSecTime,                                        NM003.GT_HEADER.TM);
  StrToArr(sMsg,                                               NM003.NOTI_MSG);
  StrToArr('N',                                                NM003.REFRESH_YN);

  sValue := RecordToStr(NM003, SizeOf(NM003));
  MastDB.iwNotiClient.DataToSend := sValue + __EOL;
end;

end.


