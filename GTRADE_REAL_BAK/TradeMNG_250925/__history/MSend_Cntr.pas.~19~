unit MSend_Cntr;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, RzLstBox, bsSkinCtrls, VCL_Helper, MBasic, DBGridEhGrouping,
  ToolCtrlsEh, DBGridEhToolCtrls, DynVarsEh, GridsEh, DBAxisGridsEh, DBGridEh,
  RzDBEdit, kcRaizeCtrl, StdCtrls, RzCmboBx, RzDBCmbo, RzSplit, Mask, RzEdit,
  bsMessages, DB, MemDS, DBAccess, Uni, ImgList, BusinessSkinForm, RzDBNav,
  bsribbon, ExtCtrls, RzPanel, PacketStruct, UniDAC_Helper, bsSkinExCtrls;

type
  TfmSend_Cntr = class(TfmBasic)
    gdMain: TDBGridEh;
    RzPanel1: TRzPanel;
    RzPanel8: TRzPanel;
    RzPanel2: TRzPanel;
    cbCheckAll: TbsSkinCheckRadioBox;
    btnAllOK: TbsSkinSpeedButton;
    btnAllNo: TbsSkinSpeedButton;
    dbMainCHECK_TF: TIntegerField;
    dbMainUSER_ID: TStringField;
    dbMainRQST_TM: TStringField;
    dbMainIO_TP: TStringField;
    dbMainACNT_TP: TStringField;
    dbMainACNT_NO: TStringField;
    dbMainUSER_NM: TStringField;
    dbMainRQST_AMT: TFloatField;
    dbMainRSLT_TP: TStringField;
    dbMainRSLT_AMT: TFloatField;
    dbMainRSLT_MNG_ID: TStringField;
    dbMainRQST_TRADE_DT: TStringField;
    dbMainRQST_SYS_DT: TStringField;
    dbMainRSLT_TRADE_DT: TStringField;
    dbMainRSLT_SYS_DT: TStringField;
    dbMainRSLT_TM: TStringField;
    dbMainRJCT_MSG: TStringField;
    dbMainUSER_BANK: TStringField;
    dbMainUSER_BANK_ACNT: TStringField;
    dbMainUSER_BANK_ACNT_NM: TStringField;
    dbMainMNG_YN: TStringField;
    bsSkinLabel2: TbsSkinLabel;
    bsSkinLabel3: TbsSkinLabel;
    bsSkinLabel4: TbsSkinLabel;
    edUserID: TkcRzDBEdit;
    kcRzDBEdit1: TkcRzDBEdit;
    kcRzDBEdit2: TkcRzDBEdit;
    bsSkinDivider1: TbsSkinDivider;
    procedure FormShow(Sender: TObject);
    procedure gdMainTitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure MainTableOpen; override;
    function InOutProcCall(sRsltTp : String; sRebuffMsg : String = ''): Integer;
    procedure InOutProcAll(sRsltTp : String; sRebuffMsg : String = '');
    procedure SingleInOutProc(sRsltTp : String; sRebuffMsg : String = '');
    procedure InOutSendNM001(sMsg : String);
  end;

var
  fmSend_Cntr: TfmSend_Cntr;

implementation

uses StdUtils, MMastDB, MDelay;

{$R *.dfm}

{ TfmSample }
const
  _Approve  = '1';
  _Rebuff   = '2';

var
  _bAllCheck: Boolean=False;

procedure TfmSend_Cntr.FormShow(Sender: TObject);
begin
  inherited;
  PartTableOpen(rgType, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_DISP = %s ORDER BY CODE_VALUE', [QuotedStr('IO_TP'),QuotedStr('Y')]), '[전체]', '0');
  PartTableOpen(TComponent(gdMain.Columns[1]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('IO_TP')]));
  PartTableOpen(TComponent(gdMain.Columns[2]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('ACNT_TP')]));

  _sMainWhere := '';

  with rgType do
  begin
    Tag := 1;
    ItemIndex := 0;
    Tag := 0;
  end;

end;

procedure TfmSend_Cntr.gdMainTitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  inherited;
  with dbMain do
  begin
    if IndexFieldNames = Column.FieldName then IndexFieldNames := Column.FieldName + ' Desc'
    else IndexFieldNames := Column.FieldName
  end;
end;

procedure TfmSend_Cntr.InOutProcAll(sRsltTp: String; sRebuffMsg : String = '');
var
  iTCnt, iCnt, iRlst : Integer;
begin
  iCnt := 0;
  iTCnt := 0;

  with dbMain do
  begin
    DisableControls;
    First;
    while Not Eof do
    begin
      Edit;

      if FieldByName('CHECK_TF').AsInteger = 1 then
      begin
        iRlst := InOutProcCall(sRsltTp, sRebuffMsg);
        if iRlst = 0 then Inc(iCnt);
        Inc(iTCnt);
        Post;
      end;

      Next;
    end;
    EnableControls;
  end;
  MsgInfo('총 ' + intTostr(iTCnt) + '건' + ' / ' + intTostr(iCnt) + '건 처리완료');
  MainTableOpen;
end;

function TfmSend_Cntr.InOutProcCall(sRsltTp : String; sRebuffMsg : String = ''): Integer;
var
  db : TUniQuery;
  sMsg, sIoTp, sIoNm, sRlstNm, sSql, sRslt : String;
begin
  sIoTp := dbMain.FieldByName('IO_TP').AsString;

  if sIoTp = '1' then sIoNm := '입금요청';
  if sIoTp = '2' then sIoNm := '출금요청';

  if sRsltTp = '1' then sRlstNm := '승인';
  if sRsltTp = '2' then sRlstNm := '거부';

//  sSql := Format('PT_INOUT_PROC %s,%s,%s,%g,%s,%s',
//                 [QuotedStr(dbMain.FieldByName('USER_ID').AsString)
//                 ,QuotedStr(dbMain.FieldByName('RQST_TM').AsString)
//                 ,QuotedStr(sRsltTp)
//                 ,TextToFloat(edAmt.Text)
//                 ,QuotedStr(__Login_ID)
//                 ,QuotedStr(sRebuffMsg)]);
//
//  try
//    db := TUniQuery.Create(nil);
//    db.Connection := MastDB.UniConnection;
//
//    sRslt := Uni_Open(db, sSql);
//
//    if sRslt <> '' then
//    begin
//      GT_Log(Format('ERROR : [%s][%s]', [sRslt,sSql]), 'E');
//      exit;
//    end;
//  finally
//    FreeAndNil(db);
//  end;



  with MastDB.uniSp do
  begin
    StoredProcName := 'PT_INOUT_PROC';
    PrepareSQL;
    ParamByName('I_USER_ID').AsString                 := dbMain.FieldByName('USER_ID').AsString;
    ParamByName('I_TM').AsString                      := dbMain.FieldByName('RQST_TM').AsString;
    ParamByName('I_RSLT_TP').AsString                 := sRsltTp;
    ParamByName('I_RSLT_AMT').AsFloat                 := TextToFloat(edAmt.Text);
    ParamByName('I_MNG_ID').AsString                  := __Login_ID;
    ParamByName('I_RJCT_MSG').AsString                := sRebuffMsg;

    try
      Execute;
    Except
      on E:Exception do
      begin
        Set_Log(E.Message,'E');
      end;
    end;

    Result := ParamByName('RETURN_VALUE').AsInteger;

    if Result = 0 then
    begin
      sMsg := Format('[ %s ]원 %s이 %s되었습니다.', [FormatFloat(__FORMAT_AMT, TextToFloat(edAmt.Text)), sIoNm, sRlstNm]);
      InOutSendNM001(sMsg);
    end;
  end;
end;

procedure TfmSend_Cntr.InOutSendNM001(sMsg : String);
var
  NM001  : TNM001;
  sValue : String;
begin
  FillChar(NM001, SizeOf(NM001), ' ');
  StrToArr(NumToStr(SizeOf(NM001)),                            NM001.GT_HEADER.LENGTH);
  StrToArr('NM001',                                            NM001.GT_HEADER.PACKET_CD);
  StrToArr(UpperCase(dbMain.FieldByName('USER_ID').AsString),  NM001.GT_HEADER.USER_ID);
  StrToArr(dbMain.FieldByName('ACNT_TP').AsString,             NM001.GT_HEADER.ACNT_TP);
  StrToArr('0000',                                             NM001.GT_HEADER.ERR_CODE);
  StrToArr(NowMSecTime,                                        NM001.GT_HEADER.TM);
  StrToArr(sMsg,                                               NM001.NOTI_MSG);
  StrToArr('Y',                                                NM001.REFRESH_YN);

  sValue := RecordToStr(NM001, SizeOf(NM001));
  MastDB.iwNotiClient.DataToSend := sValue + __EOL;
end;

procedure TfmSend_Cntr.MainTableOpen;
begin
  with dbMain do
  begin
  	try
      Delay_Show();

      Close;
      SQL.Text := Format( 'SELECT                    '+
                          '	 0 AS CHECK_TF           '+
                          '	,USER_ID                 '+
                          '	,RQST_TM                 '+
                          '	,IO_TP                   '+
                          '	,ACNT_TP                 '+
                          '	,ACNT_NO                 '+
                          '	,USER_NM                 '+
                          '	,RQST_AMT                '+
                          '	,RSLT_TP                 '+
                          '	,RSLT_AMT                '+
                          '	,RSLT_MNG_ID             '+
                          '	,RQST_TRADE_DT           '+
                          '	,RQST_SYS_DT             '+
                          '	,RSLT_TRADE_DT           '+
                          '	,RSLT_SYS_DT             '+
                          '	,RSLT_TM                 '+
                          '	,RJCT_MSG                '+
                          '	,USER_BANK               '+
                          '	,USER_BANK_ACNT          '+
                          '	,USER_BANK_ACNT_NM       '+
                          '	,MNG_YN                  '+
                          'FROM INOUT A              '+
                          'WHERE RSLT_TP = %s', [QuotedStr('0')]);
      if _sMainWhere <> '' then SQL.Add('AND ' + _sMainWhere);
      SQL.Add('ORDER BY RQST_TRADE_DT, RQST_TM');

      Open;
      gdMain.Columns[0].Checkboxes := RecordCount <> 0;
      cbCheckAll.Checked := False;

    finally
      Delay_Hide;
    end;
  end;
end;

procedure TfmSend_Cntr.SingleInOutProc(sRsltTp: String; sRebuffMsg : String = '');
var
  iRslt : Integer;
  sMsg, sIoTp  : String;
begin

  with dbMain do
  begin
    sIoTp := FieldByName('IO_TP').AsString;

    if sIoTp = '1' then sMsg := '입금요청';
    if sIoTp = '2' then sMsg := '출금요청';

    if sRsltTp = '1' then
    begin
      if bsMsgYesNo('[ ' + FieldByName('USER_NM').AsString + ' ]' + '님 ' + '[ ' + FormatFloat(__FORMAT_AMT, TextToFloat(edAmt.Text)) + '원 ]' + ' ' + sMsg + '을 승인하시겠습니까?', sMsg) then
      begin
        Edit;

        iRslt := InOutProcCall(sRsltTp);

        if iRslt = 0 then bsMsgInfo('처리 완료!')
        else bsMsgInfo('처리 실패!');

        Post;
        MainTableOpen;
      end;
    end;
                                                                  
    if sRsltTp = '2' then
    begin
      if bsMsgYesNo(FieldByName('USER_NM').AsString + '님 ' + sMsg + '을 거부하시겠습니까?', sMsg) then
      begin
        Edit;

        iRslt := InOutProcCall(sRsltTp, sRebuffMsg);

        if iRslt = 0 then bsMsgInfo('처리 완료!')
        else bsMsgInfo('처리 실패!');

        Post;
        MainTableOpen;
      end;
    end;
  end;

end;

end.
