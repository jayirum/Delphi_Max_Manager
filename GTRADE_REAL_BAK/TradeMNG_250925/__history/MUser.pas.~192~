unit MUser;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, RzLstBox, bsSkinCtrls, VCL_Helper, MBasic, DBGridEhGrouping,
  ToolCtrlsEh, DBGridEhToolCtrls, DynVarsEh, GridsEh, DBAxisGridsEh, DBGridEh,
  RzDBEdit, kcRaizeCtrl, StdCtrls, RzCmboBx, RzDBCmbo, RzSplit, Mask, RzEdit,
  bsMessages, DB, MemDS, DBAccess, Uni, ImgList, BusinessSkinForm, RzDBNav,
  bsribbon, ExtCtrls, RzPanel, ComCtrls, bsSkinTabs, DBCtrls, RzDTP, RzDBDTP,
  RzButton, RzRadChk, PacketStruct, UniDAC_Helper, math, Menus, bsSkinMenus,
  Clipbrd;

type
  TfmUser = class(TfmBasic)
    pnFilter: TbsSkinPanel;
    bsSkinLabel1: TbsSkinLabel;
    edFind: TRzEdit;
    pnLeft: TRzSizePanel;
    RzPanel5: TRzPanel;
    RzPanel1: TRzPanel;
    RzPanel6: TRzPanel;
    rgType: TbsSkinRadioGroup;
    gdMain: TDBGridEh;
    lbxPart: TRzListBox;
    btnDetail: TbsSkinSpeedButton;
    pgMain: TbsSkinPageControl;
    bsSkinTabSheet1: TbsSkinTabSheet;
    bsSkinTabSheet2: TbsSkinTabSheet;
    RzPanel4: TRzPanel;
    pnUser: TRzPanel;
    bsSkinLabel2: TbsSkinLabel;
    bsSkinLabel3: TbsSkinLabel;
    bsSkinLabel4: TbsSkinLabel;
    bsSkinLabel5: TbsSkinLabel;
    bsSkinLabel6: TbsSkinLabel;
    bsSkinLabel7: TbsSkinLabel;
    bsSkinLabel8: TbsSkinLabel;
    bsSkinLabel9: TbsSkinLabel;
    bsSkinLabel11: TbsSkinLabel;
    bsSkinLabel12: TbsSkinLabel;
    bsSkinLabel13: TbsSkinLabel;
    bsSkinLabel15: TbsSkinLabel;
    bsSkinLabel16: TbsSkinLabel;
    bsSkinLabel17: TbsSkinLabel;
    bsSkinLabel18: TbsSkinLabel;
    bsSkinLabel19: TbsSkinLabel;
    gdAcnt: TDBGridEh;
    dbAcnt: TUniQuery;
    RzPanel8: TRzPanel;
    bsSkinLabel42: TbsSkinLabel;
    bsSkinLabel39: TbsSkinLabel;
    bsSkinLabel38: TbsSkinLabel;
    bsSkinLabel37: TbsSkinLabel;
    bsSkinLabel27: TbsSkinLabel;
    bsSkinLabel25: TbsSkinLabel;
    bsSkinLabel45: TbsSkinLabel;
    pnAcnt: TRzPanel;
    bsSkinLabel14: TbsSkinLabel;
    acntPass: TbsSkinSpeedButton;
    bsSkinLabel20: TbsSkinLabel;
    lbAlert: TLabel;
    lbConnUser: TbsSkinLabel;
    bsSkinTabSheet3: TbsSkinTabSheet;
    bsSkinLabel10: TbsSkinLabel;
    pnUmNm: TRzPanel;
    dsAcnt: TDataSource;
    gdUserMemo: TDBGridEh;
    dbMemo: TUniQuery;
    dsMemo: TDataSource;
    cbPartNm: TkcRzDBComboBox;
    bsSkinLabel21: TbsSkinLabel;
    edUmTitle: TkcRzDBEdit;
    bsSkinLabel24: TbsSkinLabel;
    moUmBigo: TRzDBMemo;
    dbMemoUM_SEQ: TIntegerField;
    dbMemoUSER_ID: TStringField;
    dbMemoUM_DT: TDateTimeField;
    dbMemoPART_NM: TStringField;
    dbMemoUM_TITLE: TStringField;
    dbMemoUM_BIGO: TStringField;
    bsSkinTabSheet4: TbsSkinTabSheet;
    gdInout: TDBGridEh;
    RzPanel2: TRzPanel;
    RzGroupBox1: TRzGroupBox;
    RzGroupBox2: TRzGroupBox;
    pnInout: TRzPanel;
    bsSkinLabel26: TbsSkinLabel;
    bsSkinLabel28: TbsSkinLabel;
    bsSkinLabel29: TbsSkinLabel;
    bsSkinLabel30: TbsSkinLabel;
    btnCntReset: TbsSkinSpeedButton;
    bsSkinTabSheet5: TbsSkinTabSheet;
    gdLogin: TDBGridEh;
    dbLogin: TUniQuery;
    dsLogin: TDataSource;
    RzPanel7: TRzPanel;
    pnLogin: TRzPanel;
    lbLogin: TbsSkinLabel;
    dbAcntACNT_NO: TStringField;
    dbAcntACNT_TP: TStringField;
    dbAcntUSER_ID: TStringField;
    dbAcntUSER_NM: TStringField;
    dbAcntACNT_PWD: TStringField;
    dbAcntGUJA_CNT: TIntegerField;
    dbAcntNEGO_GUJA_MAXCNT: TIntegerField;
    dbAcntAPI_TP: TStringField;
    dbAcntBF_ACNT_AMT: TFloatField;
    dbAcntACNT_AMT: TFloatField;
    dbAcntCLR_PL: TFloatField;
    dbAcntCLR_PL_F: TFloatField;
    dbAcntCMSN: TFloatField;
    dbAcntCMSN_F: TFloatField;
    dbAcntACNT_STATE: TStringField;
    dbAcntCONN_YN: TStringField;
    dbAcntNEGO_DUP_YN: TStringField;
    dbAcntFIRST_DT: TStringField;
    dbAcntLOGIN_DT: TStringField;
    dbAcntLOGIN_TM: TStringField;
    dbAcntLOGIN_IP: TStringField;
    dbAcntACNT_BIGO: TStringField;
    dbAcntLOSSCUT_YN: TStringField;
    dbAcntOVERNGT_YN: TStringField;
    dbAcntPLAMT: TFloatField;
    tmOpen: TTimer;
    bsSkinLabel31: TbsSkinLabel;
    dbLoginUSER_ID: TStringField;
    dbLoginLOGIN_DT: TStringField;
    dbLoginLOGIN_TM: TStringField;
    dbLoginLOGIN_IP: TStringField;
    dbLoginACNT_TP: TStringField;
    dbLoginLOGIN_TP: TStringField;
    dbLoginLOGIN_MAC: TStringField;
    dbLoginAPP_TP: TStringField;
    dbLoginHTS_VER: TStringField;
    dbLoginTOTCNT: TIntegerField;
    bsSkinLabel32: TbsSkinLabel;
    dbAcntMINAMT_GUJA: TFloatField;
    bsSkinLabel33: TbsSkinLabel;
    bsSkinLabel34: TbsSkinLabel;
    dbAcntLEVERAGE: TIntegerField;
    chBlackUser: TbsSkinCheckBox;
    bsSkinLabel36: TbsSkinLabel;
    Label1: TLabel;
    btnSign: TbsSkinSpeedButton;
    bsSkinLabel35: TbsSkinLabel;
    lbSign: TbsSkinLabel;
    bsSkinLabel40: TbsSkinLabel;
    bsSkinLabel41: TbsSkinLabel;
    edOutAcntAmt: TRzEdit;
    edOutAmt: TRzEdit;
    moOutMsg: TRzMemo;
    btnOut: TbsSkinButton;
    edInAcntAmt: TRzEdit;
    edInAmt: TRzEdit;
    cbInPart: TkcRzComboBox;
    edBosangMsg: TRzMemo;
    btnIn: TbsSkinButton;
    btnClear: TbsSkinSpeedButton;
    chLogin: TbsSkinCheckBox;
    bsSkinLabel43: TbsSkinLabel;
    pmLogin: TbsSkinPopupMenu;
    IP1: TMenuItem;
    N1: TMenuItem;
    N2: TMenuItem;
    IP2: TMenuItem;
    N3: TMenuItem;
    Label2: TLabel;
    bsSkinLabel44: TbsSkinLabel;
    userPass: TbsSkinSpeedButton;
    btnAcntMake: TbsSkinButton;
    bsSkinButton1: TbsSkinButton;
    btnNegoArtc: TbsSkinButton;
    N4: TMenuItem;
    IP3: TMenuItem;
    N5: TMenuItem;
    bsSkinLabel46: TbsSkinLabel;
    edUserID: TkcRzDBEdit;
    cbUser_Black: TkcRzDBComboBox;
    edUserNickName: TkcRzDBEdit;
    edUser_Nm: TkcRzDBEdit;
    cbUser_Grade: TkcRzDBComboBox;
    cbUserPart: TkcRzDBComboBox;
    edRegNo: TkcRzDBEdit;
    edRegDt: TRzDBDateTimePicker;
    cbServerIP: TkcRzDBComboBox;
    edPass: TkcRzDBEdit;
    cbPartnerNick: TkcRzDBComboBox;
    edEmail: TkcRzDBEdit;
    edTelNo: TkcRzDBEdit;
    edHpNo: TkcRzDBEdit;
    edAddr1: TkcRzDBEdit;
    edUserAcnt: TkcRzDBEdit;
    edUserBank: TkcRzDBEdit;
    edAcntNm: TkcRzDBEdit;
    cbBankCD: TkcRzDBComboBox;
    moBody: TRzDBMemo;
    kcRzDBEdit1: TkcRzDBEdit;
    edBlackUser: TkcRzDBComboBox;
    edSign: TkcRzDBEdit;
    SuperViser: TRzPanel;
    bsSkinLabel22: TbsSkinLabel;
    RzPanel3: TRzPanel;
    bsSkinLabel23: TbsSkinLabel;
    edMngid: TkcRzDBEdit;
    edPassM: TkcRzDBEdit;
    lbMNGNotiYN: TbsSkinLabel;
    edMNGNotiYN: TkcRzDBComboBox;
    dbMainCHECK_TF: TIntegerField;
    dbMainUSER_ID: TStringField;
    dbMainUSER_NM: TStringField;
    dbMainUSER_NICK_NM: TStringField;
    dbMainUSER_PWD: TStringField;
    dbMainUSER_GRADE: TStringField;
    dbMainUSER_GRADE_NM: TStringField;
    dbMainPART_CD: TStringField;
    dbMainPART_NM: TStringField;
    dbMainUSER_BANK: TStringField;
    dbMainUSER_BANK_ACNT: TStringField;
    dbMainUSER_BANK_ACNT_NM: TStringField;
    dbMainPARTNER_ID: TStringField;
    dbMainPARTNER_NM: TStringField;
    dbMainPARTNER_NICK_NM: TStringField;
    dbMainREG_DT: TDateTimeField;
    dbMainSERVER_IP: TStringField;
    dbMainBIRTH_DT: TStringField;
    dbMainUPDATE_MNG_ID: TStringField;
    dbMainUPDATE_DT: TStringField;
    dbMainUPDATE_TM: TStringField;
    dbMainUPDATE_IP: TStringField;
    dbMainUSER_ADDR: TStringField;
    dbMainUSER_EMAIL: TStringField;
    dbMainUSER_TEL: TStringField;
    dbMainUSER_HP: TStringField;
    dbMainUSER_BIGO: TStringField;
    dbMainUSER_REAL: TStringField;
    dbMainMNG_NOTI_YN: TStringField;
    dbMainUSER_SIGN: TStringField;
    dbMainRECOMM_NM: TStringField;
    dbMainBANK_CD: TIntegerField;
    dbMainUSER_BLACK: TStringField;
    dbMainPLAMT: TFloatField;
    dbMainLASTCNTRDT: TStringField;
    dbMainLOGIN_DT: TStringField;
    dbMainACNT_STATE: TStringField;
    dbMainBANK_DISP_NM: TStringField;
    bsSkinLabel47: TbsSkinLabel;
    cbAcntTp: TkcRzDBComboBox;
    edAcntPwd: TkcRzDBEdit;
    edAcntNo: TkcRzDBEdit;
    cbApiIp: TkcRzDBComboBox;
    cbAcntStat2: TkcRzDBComboBox;
    cbDupYn: TkcRzDBComboBox;
    edGujaMaxCnt: TkcRzEdit;
    ckGujaYn: TRzCheckBox;
    edMinAmtGuja: TkcRzDBEdit;
    cbLvg: TkcRzDBComboBox;
    kcRzDBComboBox1: TkcRzDBComboBox;
    kcRzDBEdit2: TkcRzDBEdit;
    moAcntBigo: TRzDBMemo;
    procedure FormShow(Sender: TObject);
    procedure lbxPartClick(Sender: TObject);
    procedure rgTypeClick(Sender: TObject);
    procedure btnInsertClick(Sender: TObject);
    procedure btnFilterClick(Sender: TObject);
    procedure edFindKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnExcelClick(Sender: TObject);
    procedure edUserIDChange(Sender: TObject);
    procedure dbMainBeforePost(DataSet: TDataSet);
    procedure dbMainAfterInsert(DataSet: TDataSet);
    procedure dbMainAfterEdit(DataSet: TDataSet);
    procedure btnDetailClick(Sender: TObject);
    procedure userPassClick(Sender: TObject);
    procedure btnEditClick(Sender: TObject);
    procedure btnDeleteClick(Sender: TObject);
    procedure btnPostClick(Sender: TObject);
    procedure edAcntNoChange(Sender: TObject);
    procedure pgMainChange(Sender: TObject);
    procedure acntPassClick(Sender: TObject);
    procedure edUserIDExit(Sender: TObject);
    procedure dbMainBeforeDelete(DataSet: TDataSet);
    procedure edUserNickNameExit(Sender: TObject);
    procedure btnAcntMakeClick(Sender: TObject);
    procedure bsSkinButton1Click(Sender: TObject);
    procedure dbMainBeforeEdit(DataSet: TDataSet);
    procedure dbMemoBeforePost(DataSet: TDataSet);
    procedure edInAmtExit(Sender: TObject);
    procedure edInAmtEnter(Sender: TObject);
    procedure btnInClick(Sender: TObject);
    procedure btnOutClick(Sender: TObject);
    procedure edInAmtKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure ckGujaYnClick(Sender: TObject);
    procedure btnCntResetClick(Sender: TObject);
    procedure tmOpenTimer(Sender: TObject);
    procedure dbAcntBeforeDelete(DataSet: TDataSet);
    procedure gdMainTitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
    procedure chBlackUserClick(Sender: TObject);
    procedure cbPartnerNickCloseUp(Sender: TObject);
    procedure btnSignClick(Sender: TObject);
    procedure cbInPartChange(Sender: TObject);
    procedure btnClearClick(Sender: TObject);
    procedure dbAcntBeforePost(DataSet: TDataSet);
    procedure IP1Click(Sender: TObject);
    procedure N1Click(Sender: TObject);
    procedure IP2Click(Sender: TObject);
    procedure N3Click(Sender: TObject);
    procedure btnNegoArtcClick(Sender: TObject);
    procedure IP3Click(Sender: TObject);
    procedure N5Click(Sender: TObject);
    procedure dbAcntAfterPost(DataSet: TDataSet);
    procedure dbMainAfterPost(DataSet: TDataSet);
    procedure dbPartAfterPost(DataSet: TDataSet);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure MainTableOpen; override;
    procedure passInit(sFlag : String);
    procedure negoCmsnDelete(sData : String; sWhere : String='');
    procedure InOutProc(sIoTp : String; iAmt : Double);
    procedure InOutSendNM001(sData : String);
    procedure LoginCnt;
    procedure pgOpen;
    procedure AcntMstOpen(sId : String);
    function PosCheck(sId : String): Boolean;
  end;

var
  fmUser: TfmUser;

const
  MAIN_USER_ID 				= 0;
  MAIN_USER_NM 				= 1;
  MAIN_USER_NICK_NM 		= 2;
  MAIN_USER_GRADE 			= 3;
  MAIN_PART_CD 				= 4;
  MAIN_REG_DT 					= 5;
  MAIN_USER_HP 				= 6;
  MAIN_USER_EMAIL 			= 7;
  MAIN_PARTNER_NICK_NM	= 8;
  MAIN_BIRTH_DT 				= 9;
  MAIN_USER_TEL 				= 10;
  MAIN_LASTCNTRDT 			= 11;
  MAIN_LOGIN_DT 				= 12;
  MAIN_SERVER_IP 			= 13;

implementation

uses StdUtils, MMastDB, MDelay, MUserFilter, MAcntMake, MNegoCmsn, MNego_Artc;

{$R *.dfm}

{ TfmSample }

procedure TfmUser.acntPassClick(Sender: TObject);
begin
  inherited;
  passInit('ACNT');
end;

procedure TfmUser.bsSkinButton1Click(Sender: TObject);
begin
  inherited;
  fmNegoCmsn_Run(dbMain.FieldByName('USER_ID').AsString, dbMain.FieldByName('USER_NM').AsString, dbAcnt.FieldByName('ACNT_NO').AsString, dbAcnt.FieldByName('ACNT_TP').AsString);
end;

procedure TfmUser.btnInClick(Sender: TObject);
var
  sSql, sRlst, sAcntTp : String;
begin
  inherited;
  sAcntTp := dbAcnt.FieldByName('ACNT_NO').AsString;

  if bsMsgYesNo('[ ' + dbAcnt.FieldByName('USER_NM').AsString + ' ] 님 [' + FormatFloat(__FORMAT_AMT, TextToFloat(edInAmt.Text)) +'] 원 ' + '입금처리 하시겠습니까?', '입금처리') then
  begin
    if CompareValue(TextToFloat(edInAmt.Text),0) <= 0  then
    begin
      bsMsgError('입금금액을 확인하세요!');
      Exit;
    end;
    InOutProc('1', TextToFloat(edInAmt.Text));

    AcntMstOpen(dbAcnt.FieldByName('USER_ID').AsString);

    dbAcnt.Locate('ACNT_NO', sAcntTp, []);
  end;
  edInAmt.Text := '0';
end;

procedure TfmUser.btnAcntMakeClick(Sender: TObject);
var
  sRslt : BOOLEAN;
  sSql  : String;
begin
  inherited;
  sRslt := fmAcntMake_Run(dbMain.FieldByName('USER_ID').AsString, dbMain.FieldByName('USER_NM').AsString);

  if sRslt then
  begin
    AcntMstOpen(dbMain.FieldByName('USER_ID').AsString);
  end;

end;

procedure TfmUser.btnClearClick(Sender: TObject);
begin
	edBosangMsg.Text := '';
end;

procedure TfmUser.btnCntResetClick(Sender: TObject);
begin
//  LoginCnt;
  rgType.ItemIndex := -1;

  chLogin.Checked := True;

  MainTableOpen;

  chLogin.Checked := False;
end;

procedure TfmUser.btnDeleteClick(Sender: TObject);
var
  sSql : String;
begin
  Case pgMain.ActivePageIndex of
    0 : begin
//          DeleteWork(dbMain);
        with dbMain do
          begin
            if Bof and Eof then Exit;

            if bsMsgYesNo('회원정보 및 계좌정보를 삭제하시겠습니까?') then Delete;
          end;
        end;
    1 : begin
//          bsMsgInfo('[ '+ dbacnt.FieldByName('ACNT_NO').AsString +' ]' + '계좌 삭제선택!');
//          DeleteWork(dbAcnt);
          with dbAcnt do
          begin
            if Bof and Eof then Exit;

            if bsMsgYesNo('[ '+ FieldByName('ACNT_NO').AsString +' ]' + '계좌를 삭제하시겠습니까?') then
            begin
              sSql := Format('AND ACNT_NO = %s',[QuotedStr(FieldByName('ACNT_NO').AsString)]);
              negoCmsnDelete(FieldByName('USER_ID').AsString, sSql);
              Delete;
            end;
          end;
        end;
  end;
end;

procedure TfmUser.btnDetailClick(Sender: TObject);
var
  sSQL: String;
begin
  inherited;

  sSQL := UserFilter_Run;

  if sSQL <> '' then _sMainWhere := sSQL;

  MainTableOpen;
end;

procedure TfmUser.userPassClick(Sender: TObject);
begin
  inherited;
  passInit('USER');
end;

procedure TfmUser.btnEditClick(Sender: TObject);
begin
  Case pgMain.ActivePageIndex of
    0 : begin
          EditWork(dbMain);
        end;
    1 : begin
          EditWork(dbAcnt);
        end;
  end;
end;

procedure TfmUser.btnExcelClick(Sender: TObject);
begin
  inherited;
  Export_Excel(gdMain);
end;

procedure TfmUser.btnFilterClick(Sender: TObject);
begin
	if edFind.Text = '' then _sMainWhere := ''
  else
  	_sMainWhere := StrReplace(__Find_User1, '<X>', edFind.Text);

//  LoginCnt;

  inherited;
end;

procedure TfmUser.btnInsertClick(Sender: TObject);
begin
  Case pgMain.ActivePageIndex of
    0 : begin
          edUserID.SetFocus;
          AppendWork(dbMain);
        end;
    1 : begin
          bsMsgInfo('주문계좌는 추가 불가능합니다.');
        end;
    2 : begin
          cbPartNm.SetFocus;
          AppendWork(dbMemo);
        end;
  end;
end;

procedure TfmUser.btnNegoArtcClick(Sender: TObject);
begin
  inherited;
	NeroArtc_Run(dbMain.FieldByName('USER_ID').AsString, dbMain.FieldByName('USER_NM').AsString);
end;

procedure TfmUser.btnOutClick(Sender: TObject);
var
  sSql , sAcntTp: String;
begin
  inherited;
  sAcntTp := dbAcnt.FieldByName('ACNT_NO').AsString;

  if bsMsgYesNo('[ ' + dbAcnt.FieldByName('USER_NM').AsString + ' ] 님 [' + FormatFloat(__FORMAT_AMT, TextToFloat(edOutAmt.Text)) + '] 원 ' + '출금처리 하시겠습니까?', '출금처리') then
  begin
    if CompareValue(TextToFloat(edOutAmt.Text),0) <= 0  then
    begin
      bsMsgError('출금금액을 확인하세요!');
      Exit;
    end;

//    if CompareValue(TextToFloat(edOutAcntAmt.Text), TextToFloat(edOutAmt.Text)) < 0 then
//    begin
//      bsMsgError('출금가능금액을 초과하였습니다!');
//      Exit;
//    end;

    InOutProc('2', TextToFloat(edOutAmt.Text));

    AcntMstOpen(dbAcnt.FieldByName('USER_ID').AsString);

    dbAcnt.Locate('ACNT_NO', sAcntTp, []);
  end;
  edOutAmt.Text := '0';
end;

procedure TfmUser.btnPostClick(Sender: TObject);
var
  sSql, sAcntTp : String;
  sGujaCnt : Integer;
begin
  Case pgMain.ActivePageIndex of
    0 : begin
          PostWork(dbMain);
        end;
    1 : begin
          sAcntTp := dbAcnt.FieldByName('ACNT_NO').AsString;

          if Not ckGujaYn.Checked then
          begin
            sGujaCnt := -1;
          end
          else sGujaCnt := StrToInt(edGujaMaxCnt.Text);

          sSql := Format('UPDATE ACNT_MST SET NEGO_GUJA_MAXCNT = %d WHERE ACNT_NO = %s',
                         [sGujaCnt, QuotedStr(dbAcnt.FieldByName('ACNT_NO').AsString)]);
          Uni_Open(MastDB.dbExec, sSql);

          PostWork(dbAcnt);

          AcntMstOpen(dbAcnt.FieldByName('USER_ID').AsString);

          dbAcnt.Locate('ACNT_NO', sAcntTp, []);

        end;
    2 : begin
          PostWork(dbMemo);
        end;
  end;
end;

procedure TfmUser.btnSignClick(Sender: TObject);
begin
  with dbMain do
  begin
    if State in [dsBrowse] then Edit;

    FieldByName('USER_SIGN').AsString := NumToStr(Random(9999), 4);
  end;
end;

procedure TfmUser.cbInPartChange(Sender: TObject);
begin
  edBosangMsg.Text := '';
  edBosangMsg.Text := cbInPart.Text;
  edBosangMsg.SetFocus;
end;

procedure TfmUser.cbPartnerNickCloseUp(Sender: TObject);
var
	sValue, sNickNm, sNm: String;
begin
	sValue := cbPartnerNick.Text;

  sNickNm := Get_Delimiter(sValue, 1, ',');
  sNm     := Get_Delimiter(sValue, 2, ',');

  with dbMain do
  begin
  	if State in [dsBrowse] then Edit;

    FieldByName('PARTNER_NICK_NM').AsString := sNickNm;
    FieldByName('PARTNER_NM').AsString := sNm;

    if cbPartnerNick.ItemIndex = 0 then
    begin
      FieldByName('PARTNER_NICK_NM').AsString := '';
      FieldByName('PARTNER_NM').AsString := '';
    end;
  end;
end;

procedure TfmUser.chBlackUserClick(Sender: TObject);
begin
	if chBlackUser.Checked then
  begin
    _sMainWhere := Format('USER_BLACK = %s', [QuotedStr('1')]);
    MainTableOpen;
  end
  else
  begin
    rgType.ItemIndex := -1;
    rgType.ItemIndex := 2;
  end;
end;

procedure TfmUser.ckGujaYnClick(Sender: TObject);
begin
  inherited;
  edGujaMaxCnt.ReadOnly := Not ckGujaYn.Checked;
end;

procedure TfmUser.dbAcntAfterPost(DataSet: TDataSet);
begin
  inherited;
  bsMsgInfo('저장되었습니다.');
end;

procedure TfmUser.dbAcntBeforeDelete(DataSet: TDataSet);
var
  bRslt : Boolean;
begin
  inherited;
  with DataSet do
  begin
    bRslt := PosCheck(FieldByName('USER_ID').AsString);
    if bRslt = False then
    begin
      bsMsgError('미체결주문 및 미청산포지션이 있을경우 삭제 불가능합니다.');
      Abort;
      Cancel;
    end;
  end;
end;

procedure TfmUser.dbAcntBeforePost(DataSet: TDataSet);
var
	sSQL, sAcntNo: String;
begin
	with DataSet do
  begin
    if State in [dsEdit] then
    begin
      if (FieldByName('OVERNGT_YN').NewValue = 'N') and
         (FieldByName('OVERNGT_YN').OldValue <> FieldByName('OVERNGT_YN').NewValue) then
      begin
        sSql := Format('UPDATE OVERNGT SET OVERNGT_YN = %s WHERE USER_ID = %s',
                        [QuotedStr('N'),
                         QuotedStr(FieldByName('USER_ID').AsString)]);
        Uni_Open(MastDB.dbSQL, sSql);

      	bsMsgInfo('해당 회원 기존 오버나잇을 초기화 합니다.');
      end;

      if ckGujaYn.Checked then
      begin
      	sAcntNo := FieldByName('ACNT_NO').AsString;

      	sSQL := Format('UPDATE ACNT_MST SET GUJA_CNT = DBO.FT_GUJA_CAN_CNT(%s, %s, %s) WHERE ACNT_NO = %s',
                       [QuotedStr('1'), QuotedStr(sAcntNo), QuotedStr('N'), QuotedStr(sAcntNo)]);

				Uni_Open(MastDB.dbSQL, sSql);                       
      end;
    end;
  end;
end;

procedure TfmUser.dbMainAfterEdit(DataSet: TDataSet);
begin
  inherited;
  edUserID.ReadOnly := True;
end;

procedure TfmUser.dbMainAfterInsert(DataSet: TDataSet);
begin
  inherited;
  edUserID.ReadOnly := False;
  edPass.ReadOnly := False;

	with DataSet do
  begin
    FieldByName('REG_DT').AsDateTime := Date;
    FieldByName('USER_REAL').AsString := '0';
    FieldByName('MNG_NOTI_YN').AsString := 'Y';
    FieldByName('USER_GRADE').AsString := '2';
    FieldByName('PARTNER_ID').AsString := '0';
  	FieldByName('BANK_CD').AsInteger := __BankCD_Default;
    FieldByName('USER_BLACK').AsString := '0';

//    cbServerIP.ItemIndex := 0;

    FieldByName('USER_SIGN').AsString := NumToStr(Random(9999), 4);
  end;
end;

procedure TfmUser.dbMainAfterPost(DataSet: TDataSet);
begin
  bsMsgInfo('저장되었습니다.');
end;

procedure TfmUser.dbMainBeforeDelete(DataSet: TDataSet);
var
  sSql : String;
  bRslt : Boolean;
begin
  inherited;
  with DataSet do
  begin
    if FieldByName('USER_GRADE').AsString = '9' then
    begin
      bsMsgError('슈퍼바이져 ID는 삭제 불가능합니다!');
      Abort;
      Cancel;
    end;

    bRslt := PosCheck(FieldByName('USER_ID').AsString);
    if bRslt = False then
    begin
      bsMsgError('미체결주문 및 미청산포지션이 있을경우 삭제 불가능합니다.');
      Abort;
      Cancel;
    end;

    //회원ID삭제시 계좌,개별수수료,개별공지,회원메모 전부 삭제
    sSql := Format('DELETE FROM ACNT_MST WHERE USER_ID = %s', [QuotedStr(FieldByName('USER_ID').AsString)]);
    Uni_Open(MastDB.dbSQL, sSql);

    negoCmsnDelete(FieldByName('USER_ID').AsString);

    sSql := Format('DELETE FROM NOTICE_MST WHERE USER_ID = %s', [QuotedStr(FieldByName('USER_ID').AsString)]);
    Uni_Open(MastDB.dbSQL, sSql);

    sSql := Format('DELETE FROM USER_MEMO WHERE USER_ID = %s', [QuotedStr(FieldByName('USER_ID').AsString)]);
    Uni_Open(MastDB.dbSQL, sSql);
  end;

end;

procedure TfmUser.dbMainBeforeEdit(DataSet: TDataSet);
var
  sSql : String;
begin
  inherited;
  with DataSet do
  begin

  end;
end;

procedure TfmUser.dbMainBeforePost(DataSet: TDataSet);
var
  sMsg,  sRslt, sSql, sTrim : String;
  iRslt : Integer;
begin
  inherited;

	with DataSet do
	begin
  	if Not bsMsgYesNo('회원관리를 저장하시겠습니까?') then
    begin
      Cancel;
      Exit;
    end;

    FieldByName('USER_ID').AsString := Trim(FieldByName('USER_ID').AsString);
    FieldByName('USER_NICK_NM').AsString := Trim(FieldByName('USER_NICK_NM').AsString);
    FieldByName('USER_NM').AsString := Trim(FieldByName('USER_NM').AsString);

  	sMsg := '';
  	// 필수입력값 체크
    if FieldByName('USER_ID').AsString = ''        then sMsg := '회원ID';
    if FieldByName('USER_NICK_NM').AsString = ''   then sMsg := '회원필명';
    if FieldByName('USER_NM').AsString = ''        then sMsg := '회원명';
    if FieldByName('USER_GRADE').AsString = ''     then sMsg := '회원등급';
//    if FieldByName('REG_DT').AsString = ''         then sMsg := '등록일자';
    if FieldByName('USER_PWD').AsString = ''       then sMsg := '비밀번호';
    if FieldByName('SERVER_IP').AsString = ''      then sMsg := '접속IP';

    if sMsg <> '' then
    begin
      bsMsgError(sMsg + '은(는) 반드시 입력하셔야 합니다');
      Abort;
    end;

    FieldByName('UPDATE_MNG_ID').AsString := __Login_ID;

    if State in [dsInsert] then
    begin
      FieldByName('REG_DT').AsDateTime := Date;

      dbMain.FieldByName('USER_ID').AsString := UpperCase(Trim(StrReplace(dbMain.FieldByName('USER_ID').AsString, ' ', '')));

      fmAcntMake_Run(dbMain.FieldByName('USER_ID').AsString, dbMain.FieldByName('USER_NM').AsString);
    end;

    if State in [dsEdit] then
    begin
      if FieldByName('USER_NM').OldValue <> FieldByName('USER_NM').NewValue then
      begin
        sSql := Format('UPDATE ACNT_MST SET USER_NM = %s WHERE USER_ID = %s',
                       [QuotedStr(FieldByName('USER_NM').AsString),
                        QuotedStr(FieldByName('USER_ID').AsString)]);
        Uni_Open(MastDB.dbSql, sSql);
      end;
    end;

    FieldByName('USER_ID').AsString := UpperCase(FieldByName('USER_ID').AsString);
  end;
end;

procedure TfmUser.dbMemoBeforePost(DataSet: TDataSet);
var
  sMsg : String;
begin
  inherited;
  with DataSet do
  begin
    sMsg := '';
    // 필수입력값 체크
    if FieldByName('PART_NM').AsString = ''         then sMsg := '구분명';
    if FieldByName('UM_TITLE').AsString = ''        then sMsg := '제목';

    if sMsg <> '' then
    begin
      bsMsgError(sMsg + '은(는) 반드시 입력하셔야 합니다');
      Abort;
    end;

    if State in [dsInsert] then
    begin
      dbMemo.FieldByName('USER_ID').AsString := dbMain.FieldByName('USER_ID').AsString;
      dbMemo.FieldByName('UM_DT').AsDateTime := Date;
    end;
  end;
end;

procedure TfmUser.dbPartAfterPost(DataSet: TDataSet);
begin
  inherited;
  bsMsgInfo('저장되었습니다.');
end;

procedure TfmUser.edAcntNoChange(Sender: TObject);
var
  sSql : String;
  iAmt, iPosAmt : Double;
begin
  inherited;
	if edAcntNo.Text = '' then
  begin
    pnAcnt.Caption  := '계좌번호 [ ]';
    pnInout.Caption := '계좌번호 [ ]';
    Exit;
  end;

  if pgMain.ActivePageIndex = 1 then
  begin
    pnAcnt.Caption  := Format('계좌번호 [%s]', [dbAcnt.FieldByName('ACNT_NO').AsString]);

    sSql := Format('SELECT dbo.FT_GUJA_MAX_CNT(%s,%s) AS RSLT',
                     [QuotedStr(dbAcnt.FieldByName('ACNT_TP').AsString),
                      QuotedStr(dbAcnt.FieldByName('ACNT_NO').AsString)]);
    Uni_Open(MastDB.dbSql, sSql);

    edGujaMaxCnt.Text := MastDB.dbSql.FieldByName('RSLT').AsString;

    ckGujaYn.Checked := dbAcnt.FieldByName('NEGO_GUJA_MAXCNT').AsInteger <> -1;
  end;

  if pgMain.ActivePageIndex = 3 then
  begin
    pnInout.Caption := Format('계좌번호 [%s]', [dbAcnt.FieldByName('ACNT_NO').AsString]);

    with dbAcnt do
    begin
      iAmt:= FieldByName('ACNT_AMT').AsFloat + FieldByName('CLR_PL').AsFloat - FieldByName('CMSN').AsFloat;

//      sSql := Format('SELECT COUNT(*) AS POSCNT FROM NCLR_POS WHERE ACNT_NO = %s', [QuotedStr(FieldByName('ACNT_NO').AsString)]);
//      Uni_Open(MastDB.dbSQL, sSql);
//
//      sSql := Format('SELECT COUNT(*) AS QTYCNT FROM ORD WHERE ACNT_NO = %s AND REMN_QTY > 0', [QuotedStr(FieldByName('ACNT_NO').AsString)]);
//      Uni_Open(MastDB.dbExec, sSql);
//
//      if (MastDB.dbSQL.FieldByName('POSCNT').AsInteger = 0) and (MastDB.dbExec.FieldByName('QTYCNT').AsInteger = 0) then iPosAmt := iAmt
//      else iPosAmt := 0;

      edInAcntAmt.Text  := FormatFloat(__FORMAT_AMT, iAmt);
      edOutAcntAmt.Text := FormatFloat(__FORMAT_AMT, iAmt);
//      edPosAmt.Text     := FormatFloat(__FORMAT_AMT, iPosAmt);
    end;
  end;

end;

procedure TfmUser.edFindKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  inherited;
	if Key = 13 then btnFilter.ButtonClick;
end;

procedure TfmUser.edInAmtEnter(Sender: TObject);
begin
  inherited;
  TRzEdit(Sender).Text := StrReplace(TRzEdit(Sender).Text, ',', '');
//  edInAmt.Text := StrReplace(edInAmt.Text, ',', '');
end;

procedure TfmUser.edInAmtExit(Sender: TObject);
begin
  inherited;
  TRzEdit(Sender).Text := FormatFloat(__FORMAT_AMT, StrToFloatDef(TRzEdit(Sender).Text, 0));
//  edInAmt.Text := FormatFloat(__FORMAT_AMT, StrToFloatDef(edInAmt.Text, 0));
end;

procedure TfmUser.edInAmtKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  inherited;
  if Key = 13 then btnIn.ButtonClick;
end;

procedure TfmUser.edUserIDChange(Sender: TObject);
var
  sGrade, sSql : String;
begin
  inherited;

	if edUserID.Text = '' then Exit;

  with dbMain do
  begin
    pnUser.Caption  := Format('회원명 [%s]', [FieldByName('USER_NM').AsString]);
    pnUmNm.Caption  := Format('회원명 [%s]', [FieldByName('USER_NM').AsString]);
    pnLogin.Caption := Format('회원명 [%s]', [FieldByName('USER_NM').AsString]);

    if __Supervisor then sGrade := '9'
    else sGrade := '8';

    cbUser_Grade.ReadOnly := FieldByName('USER_GRADE').AsString = sGrade;
    lbMNGNotiYN.Visible   := FieldByName('USER_GRADE').AsString = '8';
    edMNGNotiYN.Visible   := FieldByName('USER_GRADE').AsString = '8';
  end;

  tmOpen.Enabled := False;
  tmOpen.Enabled := True;
//  pgOpen;

end;

procedure TfmUser.edUserIDExit(Sender: TObject);
var
  sSql : String;
begin
  inherited;
  lbAlert.Caption := '';

  if (dbMain.State in [dsBrowse]) or (edUserID.Text = '') then Exit;

  if dbMain.State in [dsInsert] then
  begin
    with MastDB.dbSQL do
    begin

        sSql := Format('SELECT COUNT(1) AS CNT FROM USER_MST WHERE USER_ID = %s', [QuotedStr(Trim(StrReplace(edUserID.Text, ' ', '')))]);

        Uni_Open(MastDB.dbSQL, sSql);

        if FieldByName('CNT').AsInteger > 0 then
        begin
          lbAlert.Visible := TRUE;
          lbAlert.Caption := '중복된 ID 입니다..';
          dbMain.FieldByName('USER_ID').AsString := '';
          edUserID.SetFocus;
        end;
    end;
  end;

end;

procedure TfmUser.edUserNickNameExit(Sender: TObject);
var
  sSql : String;
begin
  inherited;
  lbAlert.Caption := '';

  if (dbMain.State in [dsBrowse]) or (edUserID.Text = '') then Exit;

  if dbMain.FieldByName('USER_NICK_NM').OldValue = dbMain.FieldByName('USER_NICK_NM').NewValue then Exit;

  with MastDB.dbSQL do
  begin

      sSql := Format('SELECT COUNT(1) AS CNT FROM USER_MST WHERE USER_NICK_NM = %s', [QuotedStr(edUserNickName.Text)]);

      Uni_Open(MastDB.dbSQL, sSql);

      if FieldByName('CNT').AsInteger > 0 then
      begin
        lbAlert.Visible := TRUE;
        lbAlert.Caption := '중복된 회원필명 입니다..';
        dbMain.FieldByName('USER_NICK_NM').AsString := '';
        edUserNickName.SetFocus;
      end;
  end;


  with MastDB.dbSQL do
  begin

      sSql := Format('SELECT COUNT(1) AS CNT FROM USER_MST WHERE USER_NICK_NM = %s', [QuotedStr(edUserNickName.Text)]);

      Uni_Open(MastDB.dbSQL, sSql);

      if FieldByName('CNT').AsInteger > 0 then
      begin
        lbAlert.Visible := TRUE;
        lbAlert.Caption := '중복된 회원필명 입니다..';
        dbMain.FieldByName('USER_NICK_NM').AsString := '';
        edUserNickName.SetFocus;
      end;
  end;

end;

procedure TfmUser.FormShow(Sender: TObject);
var
  sCd, sSql : String;
begin
  pgMain.ActivePageIndex := 0;

  if UpperCase(Copy(__Login_ID,1,2)) = 'TM' then edPass.PasswordChar := #7;

  lbSign.Visible  := __UserSignYN;
  edSign.Visible  := __UserSignYN;
  btnSign.Visible := __UserSignYN;

  if __Supervisor then sCd := '9' else sCd := '8';

	PartTableOpen(lbxPart, '회원분류', '[전체]', 'ALL');
	PartTableOpen(cbUserPart, '회원분류', ' ', ' ');
//	PartTableOpen(TComponent(gdMain.Columns[4]), '회원분류');
  PartTableOpen(cbServerIP, '@|SERVER_NM, SERVER_IP|SERVER_MST');
//  PartTableOpen(rgType, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE'),QuotedStr(sCd)]), '[전체]', '0');
//  PartTableOpen(cbUser_Grade, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE'),QuotedStr(sCd)]));
//	PartTableOpen(TComponent(gdMain.Columns[MAIN_USER_GRADE]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE')]));
  PartTableOpen(TComponent(gdAcnt.Columns[1]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));
  PartTableOpen(TComponent(gdInOut.Columns[1]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));
  PartTableOpen(cbAcntStat2, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_STATE')]));
  PartTableOpen(cbPartnerNick, Format('@|USER_NICK_NM+%s+USER_NM, USER_ID|USER_MST|WHERE USER_GRADE IN (%s) ORDER BY USER_NICK_NM ', [QuotedStr(','),QuotedStr('3')]), '[없음]', '0');
  PartTableOpen(cbPartNm, Format('@|PART_NM, PART_NM|PART_MST|WHERE PART_TP = %s' , [QuotedStr('메모분류')]));
  PartTableOpen(cbApiIp, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('API_TP')]));
  PartTableOpen(cbInPart, Format('@|PART_NM, PART_NM|PART_MST|WHERE PART_TP = %s' , [QuotedStr('관리자입금분류')]));

  PartTableOpen(cbBankCD, '@|BANK_DISP_NM, BANK_CD|BANK_MST');

  if sCd = '9' then
  begin
    PartTableOpen(rgType, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE'),QuotedStr(sCd)]), '[전체]', '0');
    PartTableOpen(cbUser_Grade, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE'),QuotedStr(sCd)]));
  end
  else
  begin
    PartTableOpen(rgType, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE'),QuotedStr('7')]), '[전체]', '0');
    PartTableOpen(cbUser_Grade, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < %s ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE'),QuotedStr('7')]));
  end;

  PartTableOpen(cbAcntTp, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));
  PartTableOpen(cbLvg, '@|LEVERAGE, LEVERAGE|LVG_MST');

  with rgType do
  begin
    Tag := 1;
    ItemIndex := 2;
    Tag := 0;
  end;

	_sMainWhere := '';

  _sMainWhere := 'USER_GRADE = ' + QuotedStr(rgType.Values[rgType.ItemIndex]);

//  //계좌DB
//  sSql := 'SELECT * FROM ACNT_MST';
//  Uni_Open(dbAcnt,sSql);
//
//  //회원상담
//  sSql := 'SELECT * FROM USER_MEMO';
//  Uni_Open(dbMemo,sSql);
  pgOpen;

//  LoginCnt;

  cbLvg.Enabled := __MINI_YN;
end;

procedure TfmUser.gdMainTitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  with dbMain do
  begin
    if IndexFieldNames = Column.FieldName then
    begin
      IndexFieldNames := Column.FieldName + ' Desc';
      First;
    end
    else
    begin
      IndexFieldNames := Column.FieldName;
      First;
    end;
  end;
end;

procedure TfmUser.InOutProc(sIoTp : String; iAmt : Double);
var
  sSql, sRlst, sTpNm, sMsg, sBosangMsg : String;
begin
  if sIoTp = '1' then
  begin
   sTpNm := '입금';
   sBosangMsg := edBosangMsg.Text;
  end;
  if sIoTp = '2' then
  begin
   sTpNm := '출금';
   sBosangMsg := moOutMsg.Text;
  end;

  sSql := Format('PT_REQ_INOUT %s,%s,%s,%s,%s,%g,%s,%s,%s,%s',
                   [QuotedStr(sIoTp),
                    QuotedStr(dbAcnt.FieldByName('USER_ID').AsString),
                    QuotedStr(dbAcnt.FieldByName('ACNT_TP').AsString),
                    QuotedStr(dbAcnt.FieldByName('ACNT_NO').AsString),
                    QuotedStr(dbAcnt.FieldByName('ACNT_PWD').AsString),
                    iAmt,
                    QuotedStr('1'),
                    QuotedStr(__Login_ID),
                    QuotedStr(sBosangMsg),
                    QuotedStr('')]);
  sRlst := Uni_Open(MastDB.dbExec, sSql);

  if sRlst = '' then
  begin
    sMsg := Format('[ %s ]원 관리자에 의해서 %s되었습니다.', [FormatFloat(__FORMAT_AMT, iAmt), sTpNm]);
    InOutSendNM001(sMsg);
    bsMsgInfo(sTpNm + '처리완료!');
//    edBosangMsg.Clear;
    moOutMsg.Clear;
  end
  else
  begin
    bsMsgError(sTpNm + '처리실패!');
  end;

end;

procedure TfmUser.InOutSendNM001(sData: String);
var
  NM001  : TNM001;
  sValue : String;
begin
  FillChar(NM001, SizeOf(NM001), ' ');
  StrToArr(NumToStr(SizeOf(NM001)),                            NM001.GT_HEADER.LENGTH);
  StrToArr('NM001',                                            NM001.GT_HEADER.PACKET_CD);
  StrToArr(UpperCase(dbAcnt.FieldByName('USER_ID').AsString),  NM001.GT_HEADER.USER_ID);
  StrToArr(dbAcnt.FieldByName('ACNT_TP').AsString,             NM001.GT_HEADER.ACNT_TP);
  StrToArr('0000',                                             NM001.GT_HEADER.ERR_CODE);
  StrToArr(NowMSecTime,                                        NM001.GT_HEADER.TM);
  StrToArr(sData,                                              NM001.NOTI_MSG);
  StrToArr('Y',                                                NM001.REFRESH_YN);

  sValue := RecordToStr(NM001, SizeOf(NM001));
  MastDB.iwNotiClient.DataToSend := sValue + __EOL;
end;

procedure TfmUser.IP1Click(Sender: TObject);
var
	sUser, sBlock, sSQL: String;
begin
  with dbLogin do
  begin
  	sUser  := Format('%s - %s(%s)', [__Trade_DT, dbMain.FieldByName('USER_NM').AsString, FieldByName('USER_ID').AsString]);
  	sBlock := FieldByName('LOGIN_IP').AsString;

    if bsMsgYesNo(Format('( %s ) 블럭IP로 등록하시겠습니까? ', [sBlock])) then
    begin
    	sSQL := Format('INSERT INTO USER_BLOCK_IP (UIP_IP, UIP_BIGO) VALUES (%s, %s)',
                     [QuotedStr(sBlock), QuotedStr(sUser)]);

      Uni_Open(MastDB.dbSQL, sSql);
    end;
  end;
end;

procedure TfmUser.IP2Click(Sender: TObject);
var
	sBlock, sSQL: String;
begin
  with dbLogin do
  begin
  	sBlock := FieldByName('LOGIN_IP').AsString;

    if bsMsgYesNo(Format('( %s ) 블럭IP를 해제하시겠습니까? ', [sBlock])) then
    begin
    	sSQL := Format('DELETE FROM USER_BLOCK_IP WHERE UIP_IP = %s', [QuotedStr(sBlock)]);

      Uni_Open(MastDB.dbSQL, sSql);
    end;
  end;
end;

procedure TfmUser.IP3Click(Sender: TObject);
begin
  inherited;
	ClipBoard.AsText := dbLogin.FieldByName('LOGIN_IP').AsString;
end;

procedure TfmUser.lbxPartClick(Sender: TObject);
begin
  inherited;

  with rgType do
  begin
  	Tag := 1;
  	ItemIndex := 0;
  	Tag := 0;
  end;

  if lbxPart.ItemIndex = 0 then _sMainWhere := ''
  else _sMainWhere := Format('PART_CD = %s', [QuotedStr(lbxPart.Values[lbxPart.ItemIndex])]);

  MainTableOpen;
end;

procedure TfmUser.LoginCnt;
var
  sSql, sKo, sGf : String;
begin
  sSql := Format( 'SELECT (SELECT COUNT(*)                                                 '+
                  '        FROM ACNT_MST WHERE CONN_YN = %s AND ACNT_TP = %s) AS KO_CNT,   '+
                  '       (SELECT COUNT(*)                                                 '+
                  '        FROM ACNT_MST WHERE CONN_YN = %s AND ACNT_TP = %s) AS GF_CNT    ',
                  [QuotedStr('Y'),
                   QuotedStr('1'),
                   QuotedStr('Y'),
                   QuotedStr('2')]);

  Uni_Open(MastDB.dbSQL, sSql);

  sKo := MastDB.dbSQL.FieldByName('KO_CNT').AsString;
  sGf := MastDB.dbSQL.FieldByName('GF_CNT').AsString;

  lbConnUser.Caption := '국내접속 : ' + sKo + '명  /  해외접속 : ' + sGf + '명';
end;

procedure TfmUser.MainTableOpen;
var
  sGrade, sWhere: String;
begin
  with dbMain do
  begin
  	try
      Delay_Show();

      Close;
      SQL.Text := Format('SELECT                ' +
                  '  0 AS CHECK_TF     , ' +
                  '  A.USER_ID					 , ' +
                  '  A.USER_NM           , ' +
                  '  A.USER_NICK_NM      , ' +
                  '  A.USER_PWD          , ' +
                  '  A.USER_GRADE        , ' +
                  ' (SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.USER_GRADE) AS USER_GRADE_NM, ' +
                  '  A.PART_CD           , ' +
                  ' (SELECT PART_NM FROM PART_MST WHERE PART_TP = %s AND PART_CD = A.PART_CD) AS PART_NM, ' +
                  '  A.USER_BANK         , ' +
                  '  A.USER_BANK_ACNT    , ' +
                  '  A.USER_BANK_ACNT_NM , ' +
                  '  A.PARTNER_ID        , ' +
                  '  A.PARTNER_NM        , ' +
                  '  A.PARTNER_NICK_NM   , ' +
                  '  A.REG_DT            , ' +
                  '  A.SERVER_IP         , ' +
                  '  A.BIRTH_DT          , ' +
                  '  A.UPDATE_MNG_ID     , ' +
                  '  A.UPDATE_DT         , ' +
                  '  A.UPDATE_TM         , ' +
                  '  A.UPDATE_IP         , ' +
                  '  A.USER_ADDR         , ' +
                  '  A.USER_EMAIL        , ' +
                  '  A.USER_TEL          , ' +
                  '  A.USER_HP           , ' +
                  '  A.USER_BIGO         , ' +
                  '  A.USER_REAL         , ' +
                  '  A.MNG_NOTI_YN       , ' +
                  '  A.USER_SIGN         , ' +
                  '  A.RECOMM_NM         , ' +
                  '  A.BANK_CD           , ' +
                  '  A.USER_BLACK        , ' +
                  ' (B.ACNT_AMT + B.CLR_PL - B.CMSN) AS PLAMT , ' +
//                  ' CASE WHEN (SELECT COUNT(1) FROM CNTR WHERE USER_ID = A.USER_ID) > 0 THEN (SELECT CURR_TRADE_DT FROM CORP_MST) ELSE (SELECT MAX(CNTR_DT) FROM CNTR_HIS WHERE USER_ID = A.USER_ID) END LASTCNTRDT , ' +
                  ' (SELECT LAST_CNTR_DT FROM ACNT_MST WHERE USER_ID = A.USER_ID) AS LASTCNTRDT , ' +
                  ' (SELECT MAX(LOGIN_DT) FROM LOGIN_HIS WHERE USER_ID = A.USER_ID AND LOGIN_TP = %s AND APP_TP = %s) AS LOGIN_DT , ' +
                  ' (SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = B.ACNT_STATE) AS ACNT_STATE, ' +
                  ' CASE WHEN BANK_CD=0 THEN %s ELSE (SELECT BANK_DISP_NM FROM BANK_MST WHERE BANK_CD=A.BANK_CD) END AS BANK_DISP_NM ' +
                  'FROM                  ' +
                  '  USER_MST A, ACNT_MST B ',
                  [QuotedStr('USER_GRADE'),
                   QuotedStr('회원분류'),
                   QuotedStr('I'),
                   QuotedStr('C'),
                   QuotedStr('ACNT_STATE'),
                   QuotedStr('기본계좌')
                   ]);

      sWhere := 'WHERE A.USER_ID = B.USER_ID AND ';

//    	if chLogin.Checked then SQL.Add(Format('%s (A.USER_ID = %s OR ', [sWhere, QuotedStr(__Login_ID)]))
//      else SQL.Add(sWhere);

    	if chLogin.Checked then SQL.Add(Format('%s A.USER_ID = %s ', [sWhere, QuotedStr(__Login_ID)]))
      else
      begin
        SQL.Add(sWhere);


        if __Supervisor then sGrade := '9'
        else sGrade := '7';

        if _sMainWhere <> '' then SQL.Add(Format('(%s) AND (A.USER_GRADE < %s) ', [_sMainWhere, sGrade]))
        else
        begin
          SQL.Add(Format('(A.USER_GRADE < %s)', [sGrade]));
        end;

    //      if chLogin.Checked then SQL.Add(')');

        SQL.Add(' ORDER BY REG_DT DESC ');
      end;

      Open;
    finally
      Delay_Hide;
    end;
  end;
end;

procedure TfmUser.N1Click(Sender: TObject);
var
	sUser, sBlock, sSQL: String;
begin
  with dbLogin do
  begin
  	sUser  := Format('%s - %s(%s)', [__Trade_DT, dbMain.FieldByName('USER_NM').AsString, FieldByName('USER_ID').AsString]);
  	sBlock := FieldByName('LOGIN_MAC').AsString;

    if sBlock = 'RECONNECT' then
    begin
      bsMsgError('RECONNECT는 블럭맥주소를 등록할 수 없습니다.');
      Exit;
    end;

    if bsMsgYesNo(Format('( %s ) 블럭맥주소로 등록하시겠습니까? ', [sBlock])) then
    begin
    	sSQL := Format('INSERT INTO USER_BLOCK_IP (UIP_IP, UIP_BIGO) VALUES (%s, %s)',
                     [QuotedStr(sBlock), QuotedStr(sUser)]);

      Uni_Open(MastDB.dbSQL, sSql);
    end;
  end;
end;

procedure TfmUser.N3Click(Sender: TObject);
var
	sBlock, sSQL: String;
begin
  with dbLogin do
  begin
  	sBlock := FieldByName('LOGIN_MAC').AsString;

    if bsMsgYesNo(Format('( %s ) 블럭맥주소를 해제하시겠습니까? ', [sBlock])) then
    begin
    	sSQL := Format('DELETE FROM USER_BLOCK_IP WHERE UIP_IP = %s', [QuotedStr(sBlock)]);

      Uni_Open(MastDB.dbSQL, sSql);
    end;
  end;
end;

procedure TfmUser.N5Click(Sender: TObject);
begin
  inherited;
  if dbLogin.FieldByName('LOGIN_MAC').AsString = 'RECONNECT' then
  begin
    bsMsgError('RECONNECT는 블럭맥주소를 복사할 수 없습니다.');
    Exit;
  end;

	ClipBoard.AsText := dbLogin.FieldByName('LOGIN_MAC').AsString;
end;

procedure TfmUser.negoCmsnDelete(sData : String; sWhere : String='');
var
  sSql : String;
begin
  sSql := Format('DELETE FROM NEGO_CMSN WHERE USER_ID = %s' + sWhere, [QuotedStr(sData)]);
  Uni_Open(MastDB.dbSQL, sSql);
end;

procedure TfmUser.passInit(sFlag : String);
var
  sVal : String;
  sData : TUniQuery;
begin
  if bsMsgYesNo('비밀번호 초기화 하시겠습니까? \n\n [1111]로 변경됩니다.') then
  begin

    if sFlag = 'USER' then
    begin
      with dbMain do
        begin
          Edit;
          FieldByName('USER_PWD').AsString := '1111';
          Post;
        end;
    end;

    if sFlag = 'ACNT' then
    begin
      with dbAcnt do
      begin
        Edit;
        FieldByName('ACNT_PWD').AsString := '1111';
        Post;
      end;
    end;

    bsMsgInfo('처리되었습니다.');

  end;
end;

procedure TfmUser.pgMainChange(Sender: TObject);
begin
  inherited;
  pgOpen;
end;

procedure TfmUser.pgOpen;
var
  sSql : String;
begin
  if pgMain.ActivePageIndex = 0 then SuperViser.Visible := __Supervisor;

  if (pgMain.ActivePageIndex = 1) or (pgMain.ActivePageIndex = 3) then
  begin
    with dbAcnt do
    begin
      Close;
      SQL.Text := Format( 'SELECT '+
                          'ACNT_NO          ,'+
                          'ACNT_TP          ,'+
                          'USER_ID          ,'+
                          'USER_NM          ,'+
                          'ACNT_PWD         ,'+
                          'GUJA_CNT         ,'+
                          'NEGO_GUJA_MAXCNT ,'+
                          'API_TP           ,'+
                          'BF_ACNT_AMT      ,'+
                          'ACNT_AMT         ,'+
                          'CLR_PL           ,'+
                          'CLR_PL_F         ,'+
                          'CMSN             ,'+
                          'CMSN_F           ,'+
                          'ACNT_STATE       ,'+
                          'CONN_YN          ,'+
                          'NEGO_DUP_YN      ,'+
                          'FIRST_DT         ,'+
                          'LOGIN_DT         ,'+
                          'LOGIN_TM         ,'+
                          'LOGIN_IP         ,'+
                          'ACNT_BIGO        ,'+
                          'LOSSCUT_YN       ,'+
                          'OVERNGT_YN       ,'+
                          'MINAMT_GUJA      ,'+
                          'LEVERAGE         ,'+
                          'PROFITCUT_AMT    ,'+
                          '(ACNT_AMT + CLR_PL - CMSN) AS PLAMT '+
                          'FROM ACNT_MST WHERE USER_ID = %s', [QuotedStr(dbMain.FieldByName('USER_ID').AsString)]);

      open;

      First;
    end;
  end;

  if pgMain.ActivePageIndex = 2 then
  begin
    with dbMemo do
    begin
      Close;
      SQL.Text := Format( 'SELECT '+
                          ' UM_SEQ   '+
                          ',USER_ID  '+
                          ',UM_DT    '+
                          ',PART_NM  '+
                          ',UM_TITLE '+
                          ',UM_BIGO  '+
                          'FROM USER_MEMO WHERE USER_ID = %s',
                          [QuotedStr(dbMain.FieldByName('USER_ID').AsString)]);

      open;

      First;
    end;
  end;

  if pgMain.ActivePageIndex = 4 then
  begin

    sSql := Format('SELECT                         '+
                   '     USER_ID,                  '+
                   '     LOGIN_DT,                 '+
                   '     LOGIN_TM,                 '+
                   '     LOGIN_IP,                 '+
                   '     ACNT_TP,                  '+
                   '     LOGIN_TP,                 '+
                   '     LOGIN_MAC,                '+
                   '     APP_TP,                   '+
                   '     HTS_VER,                  '+
                   '     COUNT(1) OVER() AS TOTCNT '+
                   'FROM LOGIN_HIS                 '+
                   'WHERE USER_ID = %s             '+
                   'ORDER BY LOGIN_DT DESC,LOGIN_TM DESC '
                   , [QuotedStr(dbMain.FieldByName('USER_ID').AsString)]);
    Uni_Open(dbLogin, sSql);

    PartTableOpen(TComponent(gdLogin.Columns[5]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));
    PartTableOpen(TComponent(gdLogin.Columns[6]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('LOGIN_TP')]));
//    PartTableOpen(TComponent(gdLogin.Columns[2]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('APP_TP')]));

    lbLogin.Caption := dbLogin.FieldByName('TOTCNT').AsString + ' 건';

  end;
end;

procedure TfmUser.rgTypeClick(Sender: TObject);
begin
  inherited;

  if rgType.Tag = 0 then
  begin
    if rgType.ItemIndex = 0 then _sMainWhere := ''
    else _sMainWhere := 'USER_GRADE = ' + QuotedStr(rgType.Values[rgType.ItemIndex]);

    MainTableOpen;

	  lbxPart.ItemIndex := 0;
  end;
end;

procedure TfmUser.AcntMstOpen(sId: String);
var
  sSql : String;
begin
  sSql := Format( 'SELECT '+
                  'ACNT_NO          ,'+
                  'ACNT_TP          ,'+
                  'USER_ID          ,'+
                  'USER_NM          ,'+
                  'ACNT_PWD         ,'+
                  'GUJA_CNT         ,'+
                  'NEGO_GUJA_MAXCNT ,'+
                  'API_TP           ,'+
                  'BF_ACNT_AMT      ,'+
                  'ACNT_AMT         ,'+
                  'CLR_PL           ,'+
                  'CLR_PL_F         ,'+
                  'CMSN             ,'+
                  'CMSN_F           ,'+
                  'ACNT_STATE       ,'+
                  'CONN_YN          ,'+
                  'NEGO_DUP_YN      ,'+
                  'FIRST_DT         ,'+
                  'LOGIN_DT         ,'+
                  'LOGIN_TM         ,'+
                  'LOGIN_IP         ,'+
                  'ACNT_BIGO        ,'+
                  'LOSSCUT_YN       ,'+
                  'OVERNGT_YN       ,'+
                  'MINAMT_GUJA      ,'+
                  'LEVERAGE         ,'+
                  '(ACNT_AMT + CLR_PL - CMSN) AS PLAMT '+
                  'FROM ACNT_MST WHERE USER_ID = %s', [QuotedStr(sId)]);

  Uni_Open(dbAcnt,sSql);

end;

procedure TfmUser.tmOpenTimer(Sender: TObject);
begin
  tmOpen.Enabled := False;

  pgOpen;
end;

function TfmUser.PosCheck(sId: String): Boolean;
var
  sSql : String;
  POSCNT, QTYCNT : Integer;
begin
  Result := True;

  sSql := Format('SELECT ACNT_NO FROM ACNT_MST WHERE USER_ID = %s', [QuotedStr(sId)]);
  Uni_Open(MastDB.dbSQL, sSql);

  with MastDB.dbSQL do
  begin
    while Not Eof do
    begin
      sSql := Format('SELECT COUNT(*) AS POSCNT FROM NCLR_POS WHERE ACNT_NO = %s', [QuotedStr(FieldByName('ACNT_NO').AsString)]);
      Uni_Open(MastDB.dbExec, sSql);
      POSCNT := MastDB.dbExec.FieldByName('POSCNT').AsInteger;

      sSql := Format('SELECT COUNT(*) AS QTYCNT FROM ORD WHERE ACNT_NO = %s AND REMN_QTY > 0', [QuotedStr(FieldByName('ACNT_NO').AsString)]);
      Uni_Open(MastDB.dbExec, sSql);
      QTYCNT := MastDB.dbExec.FieldByName('QTYCNT').AsInteger;

      if (POSCNT <> 0) or (QTYCNT <> 0) then
      begin
        Result := False;
        Break;
      end;

      Next;
    end;
  end;

end;

end.
