unit MOrdDetail;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, RzLstBox, bsSkinCtrls, VCL_Helper, MBasic, DBGridEhGrouping,
  ToolCtrlsEh, DBGridEhToolCtrls, DynVarsEh, GridsEh, DBAxisGridsEh, DBGridEh,
  RzDBEdit, kcRaizeCtrl, StdCtrls, RzCmboBx, RzDBCmbo, RzSplit, Mask, RzEdit,
  bsMessages, DB, MemDS, DBAccess, Uni, ImgList, BusinessSkinForm, RzDBNav,
  bsribbon, ExtCtrls, RzPanel, RzButton, RzRadChk, UniDAC_Helper, Math;

type
  TfmOrdDetail = class(TfmBasic)
    pnLeft: TRzSizePanel;
    RzPanel5: TRzPanel;
    gdUser: TDBGridEh;
    RzPanel6: TRzPanel;
    btnFind: TbsSkinSpeedButton;
    edFind: TRzEdit;
    dsUser: TDataSource;
    RzPanel1: TRzPanel;
    RzSizePanel1: TRzSizePanel;
    RzPanel2: TRzPanel;
    gdOrd: TDBGridEh;
    RzPanel3: TRzPanel;
    RzPanel4: TRzPanel;
    RzDBNavigator1: TRzDBNavigator;
    pnCntr: TRzPanel;
    pnOrd: TRzPanel;
    RzDBNavigator2: TRzDBNavigator;
    bsSkinLabel45: TbsSkinLabel;
    bsSkinLabel1: TbsSkinLabel;
    dbOrd: TUniQuery;
    dsOrd: TDataSource;
    dtOrdDt: TkcRzDateTimeEdit;
    btnCntrExcel: TbsSkinSpeedButton;
    btnOrdExcel: TbsSkinSpeedButton;
    dbUser: TUniQuery;
    dbMainCNTR_NO: TIntegerField;
    dbMainAPI_CNTR_NO: TStringField;
    dbMainSTK_CD: TStringField;
    dbMainARTC_CD: TStringField;
    dbMainACNT_TP: TStringField;
    dbMainACNT_NO: TStringField;
    dbMainUSER_ID: TStringField;
    dbMainBS_TP: TStringField;
    dbMainCNTR_QTY: TIntegerField;
    dbMainCNTR_PRC: TFloatField;
    dbMainCLR_PL: TFloatField;
    dbMainCLR_PL_F: TFloatField;
    dbMainCMSN_AMT: TFloatField;
    dbMainCMSN_AMT_F: TFloatField;
    dbMainEXCH_RT: TFloatField;
    dbMainCLR_TP: TStringField;
    dbMainBF_NCLR_POS_QTY: TIntegerField;
    dbMainAF_NCLR_POS_QTY: TIntegerField;
    dbMainBF_NET_ACNT_AMT: TFloatField;
    dbMainAF_NET_ACNT_AMT: TFloatField;
    dbMainORD_NO: TIntegerField;
    dbMainAPI_ORD_NO: TStringField;
    dbMainORD_PRC: TFloatField;
    dbMainORD_QTY: TIntegerField;
    dbMainORD_TP: TStringField;
    dbMainPARTNER_ID: TStringField;
    dbMainTRADE_DT: TStringField;
    dbMainCNTR_TM: TStringField;
    dbMainAPI_CNTR_TM: TStringField;
    dbMainSYS_DT: TStringField;
    dbMainCLENT_IP: TStringField;
    dbMainAPI_TP: TStringField;
    dbMainMNG_ID: TStringField;
    dbMainDOT_CNT: TIntegerField;
    dbMainCNTRPRC: TStringField;
    dbMainCLRPLF: TStringField;
    dbMainCMSNAMTF: TStringField;
    dbOrdORD_NO: TIntegerField;
    dbOrdAPI_SEQ: TIntegerField;
    dbOrdORG_ORD_NO: TIntegerField;
    dbOrdAPI_ORD_NO: TStringField;
    dbOrdAPI_ORG_ORD_NO: TStringField;
    dbOrdACNT_TP: TStringField;
    dbOrdACNT_NO: TStringField;
    dbOrdUSER_ID: TStringField;
    dbOrdSTK_CD: TStringField;
    dbOrdARTC_CD: TStringField;
    dbOrdBS_TP: TStringField;
    dbOrdORD_TP: TStringField;
    dbOrdCOND_TP: TStringField;
    dbOrdACPT_TP: TStringField;
    dbOrdORD_PRC: TFloatField;
    dbOrdSL_TP: TStringField;
    dbOrdORD_QTY: TIntegerField;
    dbOrdRJCT_QTY: TIntegerField;
    dbOrdMDFY_QTY: TIntegerField;
    dbOrdCNCL_QTY: TIntegerField;
    dbOrdCNTR_QTY: TIntegerField;
    dbOrdREMN_QTY: TIntegerField;
    dbOrdAPI_RJCT_CD: TStringField;
    dbOrdAPI_RJCT_MSG: TStringField;
    dbOrdTRADE_DT: TStringField;
    dbOrdORD_TM: TStringField;
    dbOrdCNFM_TM: TStringField;
    dbOrdAPI_TM: TStringField;
    dbOrdSYS_DT: TStringField;
    dbOrdCLIENT_IP: TStringField;
    dbOrdAPI_TP: TStringField;
    dbOrdMNG_ID: TStringField;
    dbOrdDOT_CNT: TIntegerField;
    dbOrdORDPRC: TStringField;
    edUserID: TkcRzDBEdit;
    tmOpen: TTimer;
    dbMainORDPRC: TStringField;
    dbMainBFAVGPRC: TStringField;
    dbMainAFAVGPRC: TStringField;
    dbMainBF_AVG_PRC: TFloatField;
    dbMainAF_AVG_PRC: TFloatField;
    dbUserUSER_NM: TStringField;
    dbUserUSER_ID: TStringField;
    dbMainTOTCNT: TIntegerField;
    dbOrdTOTCNT: TIntegerField;
    dtCntrDt: TkcRzDateTimeEdit;
    rgCntrAcntTp: TbsSkinRadioGroup;
    gdCntr: TDBGridEh;
    dbMainUSER_NM: TStringField;
    chUserTp: TbsSkinCheckRadioBox;
    cbUserGrade: TkcRzComboBox;
    dbMainLEVERAGE: TIntegerField;
    chTogether: TbsSkinCheckRadioBox;
    btnCntr: TbsSkinSpeedButton;
    btnOrd: TbsSkinSpeedButton;
    RzPanel7: TRzPanel;
    bsSkinLabel2: TbsSkinLabel;
    pnClrPL: TRzPanel;
    bsSkinLabel3: TbsSkinLabel;
    pnCmsn: TRzPanel;
    dbMainACNT_TP2: TStringField;
    dbMainBS_TP2: TStringField;
    dbMainCLR_TP2: TStringField;
    dbMainAPI_TP2: TStringField;
    cbPartner: TkcRzComboBox;
    Label2: TLabel;
    btnPartner: TbsSkinSpeedButton;
    procedure btnExcelClick(Sender: TObject);
    procedure btnFindClick(Sender: TObject);
    procedure edFindKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormShow(Sender: TObject);
    procedure dtCntrDtChange(Sender: TObject);
    procedure dtOrdDtChange(Sender: TObject);
    procedure btnCntrExcelClick(Sender: TObject);
    procedure btnOrdExcelClick(Sender: TObject);
    procedure rgCntrAcntTpClick(Sender: TObject);
    procedure dbOrdAfterOpen(DataSet: TDataSet);
    procedure dbMainCalcFields(DataSet: TDataSet);
    procedure gdCntr1TitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
    procedure dbOrdCalcFields(DataSet: TDataSet);
    procedure edUserIDChange(Sender: TObject);
    procedure tmOpenTimer(Sender: TObject);
    procedure dbMainAfterOpen(DataSet: TDataSet);
    procedure gdCntr1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
    procedure gdOrdDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
    procedure btnFilterClick(Sender: TObject);
    procedure gdOrdTitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
    procedure gdUserDblClick(Sender: TObject);
    procedure gdUserTitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
    procedure gdCntrTitleBtnClick(Sender: TObject; ACol: Integer;
      Column: TColumnEh);
    procedure gdCntrDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
    procedure btnCntrClick(Sender: TObject);
    procedure btnOrdClick(Sender: TObject);
    procedure btnPartnerClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure MainTableOpen; override;
    procedure UserTableOpen(sWhere : String='');
    procedure OrdTableOpen;
  end;

var
  fmOrdDetail: TfmOrdDetail;

CONST

  // 체결그리드
	C_USER_NM					= 0;
  C_CNTR_NO					= 1;
  C_API_CNTR_NO			= 2;
  C_STK_CD					= 3;
  C_ACNT_TP					= 4;
  C_BS_TR						= 5;
  C_CNTR_QTY				= 6;
  C_CNTR_PRC				= 7;
  C_CLR_PL					= 8;
  C_CLR_PL_F				= 9;
  C_CMSN_AMT				= 10;
  C_CMSN_AMT_F			= 11;
  C_EXCH_RT					= 12;
  C_CLR_TP					= 13;
  C_CNTR_TM					= 14;
  C_BF_NCLR_POS_QTY	= 15;
  C_AF_NCLR_POS_QTY	= 16;
  C_BFAVGPRC				= 17;
  C_AFAVGPRC				= 18;
  C_BF_NET_ACNT_AMT	= 19;
  C_AF_NET_ACNT_AMT	= 20;
  C_ORD_NO					= 21;
  C_ORD_PRC					= 22;
  C_ORD_QTY					= 23;
  C_ORD_TP					= 24;
  C_TRADE_DT				= 25;
  C_API_CNTR_TM			= 26;
  C_API_TP					= 27;
  C_MNG_ID					= 28;
  C_USER_ID					= 29;
  C_LEVERAGE				= 30;

  // 주문그리드
	O_ORD_NO				= 0;
  O_USER_ID				= 1;
  O_ORG_ORD_NO		= 2;
  O_API_ORD_NO		= 3;
  O_ACNT_TP				= 4;
  O_STK_CD				= 5;
  O_BS_TP					= 6;
  O_ORD_TP				= 7;
  O_COND_TP				= 8;
  O_ACPT_TP				= 9;
  O_ORDPRC				= 10;
  O_SL_TP					= 11;
  O_ORD_QTY				= 12;
  O_REMN_QTY			= 13;
  O_API_RJCT_MSG	= 14;
  O_TRADE_DT			= 15;
  O_ORD_TM				= 16;
  O_CNFM_TM				= 17;
  O_CLIENT_IP			= 18;
  O_API_TP				= 19;
  O_MNG_ID				= 20;


implementation

uses StdUtils, MMastDB, MDelay;

{$R *.dfm}

{ TfmSample }

procedure TfmOrdDetail.btnCntrClick(Sender: TObject);
begin
	MainTableOpen;
end;

procedure TfmOrdDetail.btnCntrExcelClick(Sender: TObject);
begin
  inherited;
  Export_Excel(gdCntr);
end;

procedure TfmOrdDetail.btnOrdClick(Sender: TObject);
begin
	OrdTableOpen;
end;

procedure TfmOrdDetail.btnOrdExcelClick(Sender: TObject);
begin
  inherited;
  Export_Excel(gdOrd);
end;

procedure TfmOrdDetail.btnPartnerClick(Sender: TObject);
var
	sSQL: String;
begin
  inherited;

	if __Trade_DT <> StrReplace(dtCntrDt.Text, '-', '') then
  begin
    bsMsgError('파트너변경은 금일 체결내역만 가능합니다.');
    Exit;
  end;

  if dbMain.RecordCount <= 0 then
  begin
    bsMsgError('회원 체결내역을 먼저 조회하세요.');
    Exit;
  end;

  if cbPartner.Value = '0' then
  begin
    bsMsgError('회원 체결내역을 먼저 조회하세요.');
    Exit;
  end;

  if bsMsgYesNo(Format('파트너를 [ %s ]로 변경하시겠습니까? \n\n회원관리에 파트너도 함께 변경됩니다.', [cbPartner.Text])) then
  begin
    sSql := Format('UPDATE CNTR SET PARTNER_ID = %s WHERE USER_ID = %s',
                        [QuotedStr(cbPartner.Value),
                         QuotedStr(dbUser.FieldByName('USER_ID').AsString)]);
    Uni_Open(MastDB.dbSQL, sSql);

    sSql := Format('UPDATE USER_MST SET PARTNER_ID = %s WHERE USER_ID = %s',
                        [QuotedStr(cbPartner.Value),
                         QuotedStr(dbUser.FieldByName('USER_ID').AsString)]);
    Uni_Open(MastDB.dbSQL, sSql);

    MainTableOpen;
  end;
end;

procedure TfmOrdDetail.btnExcelClick(Sender: TObject);
begin
  inherited;
//  Export_Excel(gdMain);
end;

procedure TfmOrdDetail.btnFilterClick(Sender: TObject);
begin
  inherited;
  OrdTableOpen;
end;

procedure TfmOrdDetail.btnFindClick(Sender: TObject);
var
  sWhere, sUserTp : String;
begin
  inherited;
//  if chUserTp.Checked then sUserTp := ' USER_GRADE = 2 AND '
//  else sUserTp := '';

  if __Supervisor then
  begin
    if cbUserGrade.ItemIndex <> 0 then sUserTp := Format(' USER_GRADE = %s AND ', [IntToStr(cbUserGrade.ItemIndex)])
    else if chUserTp.Checked then sUserTp := Format(' USER_GRADE IN (%s,%s) AND ', [QuotedStr('2'),QuotedStr('7')])
    else sUserTp := '';
  end
  else
  begin
    if chUserTp.Checked then sUserTp := ' USER_GRADE = 2 AND '
    else sUserTp := ' USER_GRADE <> 7 AND ';
  end;

//    sWhere := Format(' WHERE USER_NM LIKE %s', [QuotedStr('%' + edFind.Text + '%')]);
//  sWhere := ' WHERE ' + StrReplace(__Find_User, '<X>', edFind.Text);
  sWhere := Format(' WHERE %s (%s)', [sUserTp, StrReplace(__Find_User, '<X>', edFind.Text)]);

  UserTableOpen(sWhere);
end;

procedure TfmOrdDetail.dbMainAfterOpen(DataSet: TDataSet);
begin
  inherited;
//  dbMain.DB_Format('CNTR_NO', '###0');
//  dbMain.DB_Format('ORD_NO', '###0');
end;

procedure TfmOrdDetail.dbMainCalcFields(DataSet: TDataSet);
var
  iCnt : Integer;
begin
  inherited;
  with DataSet do
  begin
    iCnt := FieldByName('DOT_CNT').AsInteger;
    FieldByName('CNTRPRC').AsString  := FormatFloat(FormatDotCnt(iCnt), FieldByName('CNTR_PRC').AsFloat);
    FieldByName('CLRPLF').AsString   := FormatFloat(FormatDotCnt(iCnt), FieldByName('CLR_PL_F').AsFloat);
    FieldByName('CMSNAMTF').AsString := FormatFloat(FormatDotCnt(iCnt), FieldByName('CMSN_AMT_F').AsFloat);
    FieldByName('ORDPRC').AsString   := FormatFloat(FormatDotCnt(iCnt), FieldByName('ORD_PRC').AsFloat);
    FieldByName('BFAVGPRC').AsString   := FormatFloat(FormatDotCnt(iCnt+3), FieldByName('BF_AVG_PRC').AsFloat);
    FieldByName('AFAVGPRC').AsString   := FormatFloat(FormatDotCnt(iCnt+3), FieldByName('AF_AVG_PRC').AsFloat);
  end;
end;

procedure TfmOrdDetail.dbOrdAfterOpen(DataSet: TDataSet);
begin
  inherited;
  with DataSet do
  begin
    TFloatField(FieldByName('ORD_PRC')).DisplayFormat := __FORMAT_AMTUSD;

  end;
end;

procedure TfmOrdDetail.dbOrdCalcFields(DataSet: TDataSet);
var
  iCnt : Integer;
begin
  inherited;
  with DataSet do
  begin
    iCnt := FieldByName('DOT_CNT').AsInteger;
    FieldByName('ORDPRC').AsString  := FormatFloat(FormatDotCnt(iCnt), FieldByName('ORD_PRC').AsFloat);
  end;
end;

procedure TfmOrdDetail.dtCntrDtChange(Sender: TObject);
begin
  inherited;
//  MainTableOpen;
//  OrdTableOpen;
end;

procedure TfmOrdDetail.dtOrdDtChange(Sender: TObject);
begin
  inherited;
//  OrdTableOpen;
end;

procedure TfmOrdDetail.edFindKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  inherited;
  if Key = 13 then btnFind.ButtonClick;
end;

procedure TfmOrdDetail.edUserIDChange(Sender: TObject);
begin
  inherited;
//  if edUserID.Text = '' then Exit;
//
//  tmOpen.Enabled := False;
//  tmOpen.Enabled := True;

end;

procedure TfmOrdDetail.FormShow(Sender: TObject);
begin
  inherited;
  if __Supervisor then cbUserGrade.Visible := True;

  PartTableOpen(cbUserGrade, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s AND CODE_VALUE < 9 ORDER BY CODE_VALUE', [QuotedStr('USER_GRADE')]), '회원등급', '0');
  cbUserGrade.ItemIndex := 0;

  PartTableOpen(cbPartner, Format('@|USER_NICK_NM+%s+USER_NM, USER_ID|USER_MST|WHERE USER_GRADE IN (%s) ORDER BY USER_NICK_NM ', [QuotedStr(','),QuotedStr('3')]),'','');
  cbPartner.ItemIndex := 0;


  dtCntrDt.Date := TextToDate(__Trade_DT); //Now;
  dtOrdDt.Date  := TextToDate(__Trade_DT); //Now;

  // 미니에 불필요한 것들 HIDE
  WITH gdCntr DO
  BEGIN
    Columns[C_API_CNTR_NO].visible := false;
    Columns[C_CLR_PL_F].visible := false;
    Columns[C_CMSN_AMT_F].visible := false;
    Columns[C_EXCH_RT].visible := false;
    Columns[C_API_TP].visible := false;
  END;
  WITH gdOrd DO
  BEGIN
    Columns[O_API_ORD_NO].visible := false;
    Columns[O_API_TP].visible := false;
  END;

end;

procedure TfmOrdDetail.gdCntr1DrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
begin
  inherited;

//  if gdSelected in State  then exit;

    with TDBGridEh(Sender), TDBGridEh(Sender).DataSource.DataSet do
    begin
      if FieldByName('BS_TP').AsString = 'B' then Canvas.Font.Color := clRed
      else Canvas.Font.Color := clBlue;

      if DataCol = 5 then DefaultDrawColumnCell(Rect, DataCol, Column, TGridDrawState(State));

      Canvas.Font.Color := clBlack;
      if CompareValue(FieldByName('CLR_PL').AsFloat, 0) > 0 then Canvas.Font.Color := clRed
      else if CompareValue(FieldByName('CLR_PL').AsFloat, 0) < 0 then Canvas.Font.Color := clBlue;

      if DataCol = 8 then DefaultDrawColumnCell(Rect, DataCol, Column, TGridDrawState(State));
    end;
end;

procedure TfmOrdDetail.gdCntr1TitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  inherited;
  //필드 sortitng
  with dbMain do
  begin
    if IndexFieldNames = Column.FieldName then IndexFieldNames := Column.FieldName + ' Desc'
    else IndexFieldNames := Column.FieldName
  end;
end;

procedure TfmOrdDetail.gdCntrDrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
begin
  with TDBGridEh(Sender), TDBGridEh(Sender).DataSource.DataSet do
  begin
    if FieldByName('BS_TP').AsString = 'B' then Canvas.Font.Color := clRed
    else Canvas.Font.Color := clBlue;

    if DataCol = 5 then DefaultDrawColumnCell(Rect, DataCol, Column, TGridDrawState(State));

    Canvas.Font.Color := clBlack;
    if CompareValue(FieldByName('CLR_PL').AsFloat, 0) > 0 then Canvas.Font.Color := clRed
    else if CompareValue(FieldByName('CLR_PL').AsFloat, 0) < 0 then Canvas.Font.Color := clBlue;

    if DataCol = 8 then DefaultDrawColumnCell(Rect, DataCol, Column, TGridDrawState(State));
  end;
end;

procedure TfmOrdDetail.gdCntrTitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  //필드 sortitng
  with dbMain do
  begin
    if IndexFieldNames = Column.FieldName then IndexFieldNames := Column.FieldName + ' Desc'
    else IndexFieldNames := Column.FieldName
  end;
end;

procedure TfmOrdDetail.gdOrdDrawColumnCell(Sender: TObject; const Rect: TRect;
  DataCol: Integer; Column: TColumnEh; State: TGridDrawState);
begin
  inherited;
  with TDBGridEh(Sender), TDBGridEh(Sender).DataSource.DataSet do
  begin
    if FieldByName('BS_TP').AsString = '매수' then Canvas.Font.Color := clRed
    else Canvas.Font.Color := clBlue;

    if DataCol = 6 then DefaultDrawColumnCell(Rect, DataCol, Column, TGridDrawState(State));
  end;
end;

procedure TfmOrdDetail.gdOrdTitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  inherited;
  with dbOrd do
  begin
    if IndexFieldNames = Column.FieldName then IndexFieldNames := Column.FieldName + ' Desc'
    else IndexFieldNames := Column.FieldName
  end;
end;

procedure TfmOrdDetail.gdUserDblClick(Sender: TObject);
begin
  inherited;
  MainTableOpen;
  if chTogether.Checked then OrdTableOpen;
end;

procedure TfmOrdDetail.gdUserTitleBtnClick(Sender: TObject; ACol: Integer;
  Column: TColumnEh);
begin
  inherited;
  with dbUser do
  begin
    if IndexFieldNames = Column.FieldName then IndexFieldNames := Column.FieldName + ' Desc'
    else IndexFieldNames := Column.FieldName
  end;
end;

procedure TfmOrdDetail.MainTableOpen;
var
  sSql, sAcntTp, sTm, sTableNm: String;
begin
  sTm := __Trade_DT;

  if sTm = StrReplace(dtCntrDt.Text, '-', '') then sTableNm := 'CNTR'
  else sTableNm := 'CNTR_HIS';

  //sTableNm := 'CNTR';
  try
     Delay_Show();

     sAcntTp := '';

     if rgCntrAcntTp.ItemIndex <> 0 then sAcntTp := Format(' AND ACNT_TP = %s', [QuotedStr(intTostr(rgCntrAcntTp.ItemIndex))]);

     sSql := Format('SELECT '+
                    'CNTR_NO, '+
                    'API_CNTR_NO, '+
                    'STK_CD, '+
                    'ARTC_CD, '+
                    'ACNT_TP, '+
                    'ACNT_NO, '+
                    'USER_ID, '+
                    'BS_TP, '+
                    'CNTR_QTY, '+
                    'CNTR_PRC, '+
                    'CLR_PL, '+
                    'CLR_PL_F, '+
                    'CMSN_AMT, '+
                    'CMSN_AMT_F, '+
                    'EXCH_RT, '+
                    'CLR_TP, '+
                    'BF_NCLR_POS_QTY, '+
                    'AF_NCLR_POS_QTY, '+
                    'BF_AVG_PRC, '+
                    'AF_AVG_PRC, '+
                    'BF_NET_ACNT_AMT, '+
                    'AF_NET_ACNT_AMT, '+
                    'ORD_NO, '+
                    'API_ORD_NO, '+
                    'ORD_PRC, '+
                    'ORD_QTY, '+
                    'CASE WHEN COND_TP = 2 THEN %s ELSE (SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.ORD_TP) END ORD_TP, '+
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.ACNT_TP) AS ACNT_TP_NM, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.BS_TP) AS BS_TP_NM, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.CLR_TP) AS CLR_TP_NM, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.API_TP) AS API_TP_NM, ' +
                    'PARTNER_ID, '+
                    'TRADE_DT, '+
                    'CNTR_TM, '+
                    'API_CNTR_TM, '+
                    'SYS_DT, '+
                    'CLENT_IP, '+
                    'API_TP, '+
                    'MNG_ID, '+
                    'LEVERAGE, '+
                    '(SELECT TOP(1) DOT_CNT FROM ARTC_MST WHERE ARTC_CD = A.ARTC_CD) AS DOT_CNT, '+
                    '(SELECT USER_NM FROM USER_MST WHERE USER_ID = A.USER_ID) AS USER_NM, '+
                    'COUNT(1) OVER() AS TOTCNT '+
                    'FROM %s A '+
                    'WHERE USER_ID = %s '+
                    'AND TRADE_DT = %s  ORDER BY CNTR_NO DESC '+
                    sAcntTp,
                    [QuotedStr('예약주문'),
                     QuotedStr('ORD_TP'),
                     QuotedStr('ACNT_TP'),
                     QuotedStr('BS_TP'),
                     QuotedStr('CLR_TP'),
                     QuotedStr('API_TP'),
                     sTableNm,
                     QuotedStr(dbUser.FieldByName('USER_ID').AsString),
                     QuotedStr(StrReplace(dtCntrDt.Text, '-', ''))]);

     Uni_Open(dbMain, sSql);

//     PartTableOpen(TComponent(gdCntr.Columns[23]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ORD_TP')]));

//     PartTableOpen(TComponent(gdCntr.Columns[4]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));
//     PartTableOpen(TComponent(gdCntr.Columns[5]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('BS_TP')]));
//     PartTableOpen(TComponent(gdCntr.Columns[13]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('CLR_TP')]));
//     PartTableOpen(TComponent(gdCntr.Columns[27]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('API_TP')]));

     if dbMain.RecordCount > 0 then pnCntr.Caption := dbMain.FieldByName('TOTCNT').AsString + ' 건'
     else pnCntr.Caption := '0 건';

    pnClrPL.Caption := '';
    pnCmsn.Caption  := '';

    pnClrPL.Font.Color := clBlack;

    if sTm = StrReplace(dtCntrDt.Text, '-', '') then
    begin
      sSQL := Format('SELECT CLR_PL, CMSN FROM ACNT_MST WHERE USER_ID = %s', [QuotedStr(dbUser.FieldByName('USER_ID').AsString)]);
    end
    else
    begin
      sSQL := Format('SELECT CLR_PL_SUM AS CLR_PL, CMSN_SUM AS CMSN FROM ACNT_CLS WHERE TRADE_DT = %s AND USER_ID = %s',
                      [QuotedStr(StrReplace(dtCntrDt.Text, '-', '')),
                       QuotedStr(dbUser.FieldByName('USER_ID').AsString)]);
    end;

    Uni_Open(MastDB.dbSQL, sSql);

    with MastDB.dbSQL do
    begin
      pnClrPL.Caption := FormatFloat('#,##0', FieldByName('CLR_PL').AsFloat);
      pnCmsn.Caption  := FormatFloat('#,##0', FieldByName('CMSN').AsFloat);

      if CompareValue(FieldByName('CLR_PL').AsFloat, 0) > 0 then pnClrPL.Font.Color := clRed
    	else if CompareValue(FieldByName('CLR_PL').AsFloat, 0) < 0 then pnClrPL.Font.Color := clBlue;

      Close;
    end;

  finally
    Delay_Hide;
  end;
end;

procedure TfmOrdDetail.OrdTableOpen;
var
  sSql, sAcntTp, sTm, sTableNm : String;
begin
  sTm := __Trade_DT;
  if sTm = StrReplace(dtCntrDt.Text, '-', '') then sTableNm := 'ORD'
  else sTableNm := 'ORD_HIS';

  try
    Delay_Show();

    sAcntTp := '';

    if rgCntrAcntTp.ItemIndex <> 0 then sAcntTp := Format(' AND ACNT_TP = %s', [QuotedStr(intTostr(rgCntrAcntTp.ItemIndex))]);

    sSql := Format( 'SELECT '+
                    'ORD_NO, '+
                    'API_SEQ, '+
                    'ORG_ORD_NO, '+
                    'API_ORD_NO, '+
                    'API_ORG_ORD_NO, '+
//                    'ACNT_TP, '+
                    'ACNT_NO, '+
                    'USER_ID, '+
                    'STK_CD, '+
                    'ARTC_CD, '+
//                    'BS_TP, '+
//                    'ORD_TP, '+
//                    'COND_TP, '+
//                    'ACPT_TP, '+
                    'ORD_PRC, '+
//                    'SL_TP, '+
                    'ORD_QTY, '+
                    'RJCT_QTY, '+
                    'MDFY_QTY, '+
                    'CNCL_QTY, '+
                    'CNTR_QTY, '+
                    'REMN_QTY, '+
                    'API_RJCT_CD, '+
                    'API_RJCT_MSG, '+
                    'TRADE_DT, '+
                    'ORD_TM, '+
                    'CNFM_TM, '+
                    'API_TM, '+
                    'SYS_DT, '+
                    'CLIENT_IP, '+
//                    'API_TP, '+
                    'MNG_ID, '+
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.ACNT_TP) AS ACNT_TP, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.BS_TP) AS BS_TP, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.ORD_TP) AS ORD_TP, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.COND_TP) AS COND_TP, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.ACPT_TP) AS ACPT_TP, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.SL_TP) AS SL_TP, ' +
                    '(SELECT CODE_VALUE_NM FROM CODE_MST WHERE CODE_ID = %s AND CODE_VALUE = A.API_TP) AS API_TP, ' +
                    '(SELECT TOP(1) DOT_CNT FROM ARTC_MST WHERE ARTC_CD = A.ARTC_CD) AS DOT_CNT, '+
                    'COUNT(1) OVER() AS TOTCNT '+
                    'FROM %s A '+
                    'WHERE USER_ID = %s '+
                    'AND TRADE_DT = %s ORDER BY ORD_NO DESC '+
                   sAcntTp,
                  [QuotedStr('ACNT_TP'),
                   QuotedStr('BS_TP'),
                   QuotedStr('ORD_TP'),
                   QuotedStr('COND_TP'),
                   QuotedStr('ACPT_TP'),
                   QuotedStr('SL_TP'),
                   QuotedStr('API_TP'),
                   sTableNm,
                   QuotedStr(dbUser.FieldByName('USER_ID').AsString),
                   QuotedStr(StrReplace(dtCntrDt.Text, '-', ''))]);
    Uni_Open(dbOrd, sSql);

//    PartTableOpen(TComponent(gdOrd.Columns[4]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACNT_TP')]));
//    PartTableOpen(TComponent(gdOrd.Columns[6]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('BS_TP')]));
//    PartTableOpen(TComponent(gdOrd.Columns[7]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ORD_TP')]));
//    PartTableOpen(TComponent(gdOrd.Columns[8]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('COND_TP')]));
//    PartTableOpen(TComponent(gdOrd.Columns[9]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('ACPT_TP')]));
//    PartTableOpen(TComponent(gdOrd.Columns[11]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('SL_TP')]));
//    PartTableOpen(TComponent(gdOrd.Columns[19]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s', [QuotedStr('API_TP')]));

    if dbOrd.RecordCount > 0 then pnOrd.Caption := dbOrd.FieldByName('TOTCNT').AsString + ' 건'
    else pnOrd.Caption := '0 건';

  finally
    Delay_Hide;
  end;
end;

procedure TfmOrdDetail.rgCntrAcntTpClick(Sender: TObject);
begin
  inherited;
  MainTableOpen;
  OrdTableOpen;
end;

procedure TfmOrdDetail.tmOpenTimer(Sender: TObject);
begin
  inherited;
  tmOpen.Enabled := False;

  MainTableOpen;
  OrdTableOpen;
end;

procedure TfmOrdDetail.UserTableOpen(sWhere: String ='');
var
  sSql : String;
begin
  sSql := 'SELECT USER_NM, USER_ID '+
          'FROM USER_MST           '+
          sWhere;
  Uni_Open(dbUser, sSql);
end;

end.
