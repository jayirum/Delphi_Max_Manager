unit MArtc;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, RzLstBox, bsSkinCtrls, VCL_Helper, MBasic, DBGridEhGrouping,
  ToolCtrlsEh, DBGridEhToolCtrls, DynVarsEh, GridsEh, DBAxisGridsEh, DBGridEh,
  RzDBEdit, kcRaizeCtrl, StdCtrls, RzCmboBx, RzDBCmbo, RzSplit, Mask, RzEdit,
  bsMessages, DB, MemDS, DBAccess, Uni, ImgList, BusinessSkinForm, RzDBNav,
  bsribbon, ExtCtrls, RzPanel, UniDAC_Helper;

type
  TfmArtc = class(TfmBasic)
    RzPanel4: TRzPanel;
    pnArtc: TRzPanel;
    bsSkinLabel2: TbsSkinLabel;
    bsSkinLabel3: TbsSkinLabel;
    bsSkinLabel4: TbsSkinLabel;
    bsSkinLabel5: TbsSkinLabel;
    bsSkinLabel6: TbsSkinLabel;
    gdMain: TDBGridEh;
    bsSkinLabel8: TbsSkinLabel;
    bsSkinLabel9: TbsSkinLabel;
    bsSkinLabel1: TbsSkinLabel;
    bsSkinLabel10: TbsSkinLabel;
    bsSkinLabel11: TbsSkinLabel;
    bsSkinLabel12: TbsSkinLabel;
    bsSkinLabel15: TbsSkinLabel;
    dbMainARTC_CD: TStringField;
    dbMainARTC_NM: TStringField;
    dbMainBS_TP: TStringField;
    dbMainTICK_SIZE: TFloatField;
    dbMainTICK_SIZE_LOW: TFloatField;
    dbMainTICK_VALUE: TFloatField;
    dbMainTICK_VALUE_LOW: TFloatField;
    dbMainTICK_VALUE_USD: TFloatField;
    dbMainARTC_USE_YN: TStringField;
    dbMainDOT_CNT: TIntegerField;
    dbMainAPI_CLTL: TFloatField;
    dbMainCMSN_TP: TStringField;
    dbMainCMSN_AMTRT: TFloatField;
    dbMainCMSN_AMTRT_USD: TFloatField;
    dbMainOVERNGT_YN: TStringField;
    dbMainOVERNGT_AMT: TFloatField;
    dbMainGUJA_CNTR_CNT: TIntegerField;
    dbMainLOSSCUT_AMT: TFloatField;
    dbMainMKT_TP: TStringField;
    dbMainSTART_TM: TStringField;
    dbMainEND_TM: TStringField;
    dbMainMTR_END_TM: TStringField;
    dbMainNOTI_1_YN: TStringField;
    dbMainNOTI_3_YN: TStringField;
    dbMainNOTI_5_YN: TStringField;
    dbMainNOTI_10_YN: TStringField;
    dbMainMONTH_GAP: TIntegerField;
    dbMainTICKSIZE: TStringField;
    dbMainTICKSIZELOW: TStringField;
    dbMainCMSNTP_NGT: TStringField;
    bsSkinLabel7: TbsSkinLabel;
    bsSkinLabel13: TbsSkinLabel;
    bsSkinLabel14: TbsSkinLabel;
    dbMainSAMEHOGA_AMT: TFloatField;
    dbMainACNT_TP: TStringField;
    bsSkinLabel16: TbsSkinLabel;
    bsSkinLabel17: TbsSkinLabel;
    kcRzDBEdit1: TkcRzDBEdit;
    dbMainCMSN_TP1: TStringField;
    dbMainCMSN_AMTRT2: TFloatField;
    dbMainCMSNTP: TStringField;
    bsSkinLabel18: TbsSkinLabel;
    dbMainACNT_TP2: TStringField;
    edArtcNM: TkcRzDBEdit;
    cbArtcUseYn: TkcRzDBComboBox;
    edTickSize: TkcRzDBEdit;
    edTickValue: TkcRzDBEdit;
    edTickSizeLow: TkcRzDBEdit;
    edTickValueLow: TkcRzDBEdit;
    cbCmsnTp: TkcRzDBComboBox;
    edCmsnAmtrt: TkcRzDBEdit;
    cbCmsnTp_Ngt: TkcRzDBComboBox;
    edCmsnAmtrt_Ngt: TkcRzDBEdit;
    edGujaCntrCnt: TkcRzDBEdit;
    edLosscutAmt: TkcRzDBEdit;
    cbOverngtYn: TkcRzDBComboBox;
    edOverngtAmtDn: TkcRzDBEdit;
    edSamHogaAmt: TkcRzDBEdit;
    cbOrdState: TkcRzDBComboBox;
    bsSkinSpeedButton1: TbsSkinSpeedButton;
    btnOrdState: TbsSkinSpeedButton;
    edTickValueUsd: TkcRzDBEdit;
    edCmsnAmtrtUsd: TkcRzDBEdit;
    edExchRT: TRzEdit;
    bsSkinLabel19: TbsSkinLabel;
    bsSkinSpeedButton2: TbsSkinSpeedButton;
    procedure FormShow(Sender: TObject);
    procedure edFindKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnExcelClick(Sender: TObject);
    procedure edArtcNMChange(Sender: TObject);
    procedure dbMainAfterOpen(DataSet: TDataSet);
    procedure dbMainCalcFields(DataSet: TDataSet);
    procedure kcRzDBEdit1Change(Sender: TObject);
    procedure dbMainBeforePost(DataSet: TDataSet);
    procedure btnOrdStateClick(Sender: TObject);
    procedure bsSkinSpeedButton1Click(Sender: TObject);
    procedure bsSkinSpeedButton2Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    procedure MainTableOpen; override;
  end;

var
  fmArtc: TfmArtc;

implementation

uses StdUtils, MMastDB, MDelay;

{$R *.dfm}

{ TfmSample }

procedure TfmArtc.bsSkinSpeedButton1Click(Sender: TObject);
var
	sSQL: String;
begin
  if bsMsgYesNo(Format('현종목 주문상태를 ( %s )로 변경하시겠습니까?', [cbOrdState.Text])) then
  begin
    PostWork(dbMain);

    MainTableOpen;
  end;
end;

procedure TfmArtc.bsSkinSpeedButton2Click(Sender: TObject);
begin
  if bsMsgYesNo(Format('틱가치와 수수료를 ( %s )환율로 변경하시겠습니까?', [cbOrdState.Text])) then
  begin
    with dbMain do
    begin
	    FieldByName('TICK_VALUE').AsFloat := FieldByName('TICK_VALUE_USD').AsFloat * StrToFloatDef(edExchRT.Text, 0);
	    FieldByName('TICK_VALUE_LOW').AsFloat := FieldByName('TICK_VALUE_USD').AsFloat * StrToFloatDef(edExchRT.Text, 0);

	    FieldByName('CMSN_AMTRT').AsFloat := FieldByName('CMSN_AMTRT_USD').AsFloat * StrToFloatDef(edExchRT.Text, 0);
	    FieldByName('CMSN_AMTRT_NGT').AsFloat := FieldByName('CMSN_AMTRT_USD').AsFloat * StrToFloatDef(edExchRT.Text, 0);

  	  PostWork(dbMain);
    end;

    MainTableOpen;
  end;
end;

procedure TfmArtc.btnExcelClick(Sender: TObject);
begin
  inherited;
  Export_Excel(gdMain);
end;

procedure TfmArtc.edFindKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  inherited;
	if Key = 13 then btnFilter.ButtonClick;
end;

procedure TfmArtc.btnOrdStateClick(Sender: TObject);
var
	sSQL: String;
begin
  if bsMsgYesNo(Format('전종목 주문상태를 ( %s )로 변경하시겠습니까?', [cbOrdState.Text])) then
  begin
    sSQL := Format('UPDATE ARTC_MST SET ORD_STATE = %s', [QuotedStr(cbOrdState.Value)]);

    Uni_Open(MastDB.dbSQL, sSQL);

    MainTableOpen;
  end;
end;

procedure TfmArtc.dbMainAfterOpen(DataSet: TDataSet);
begin
  with DataSet do
  begin
    TFloatField(FieldByName('TICK_SIZE')).DisplayFormat     := '#,##0.######';
    TFloatField(FieldByName('TICK_SIZE_LOW')).DisplayFormat := '#,##0.######';

    TFloatField(FieldByName('TICK_VALUE')).DisplayFormat     := __FORMAT_AMT;
    TFloatField(FieldByName('TICK_VALUE_LOW')).DisplayFormat := __FORMAT_AMT;
    TFloatField(FieldByName('OVERNGT_AMT')).DisplayFormat    := __FORMAT_AMT;
    TFloatField(FieldByName('LOSSCUT_AMT')).DisplayFormat    := __FORMAT_AMT;
    TFloatField(FieldByName('CMSN_AMTRT')).DisplayFormat     := '#,##0.######';
    TFloatField(FieldByName('CMSN_AMTRT_NGT')).DisplayFormat := '#,##0.######';
    TFloatField(FieldByName('TICK_VALUE_USD')).DisplayFormat := '#,##0.00';
    TFloatField(FieldByName('CMSN_AMTRT_USD')).DisplayFormat := '#,##0.00';
  end;
end;

procedure TfmArtc.dbMainBeforePost(DataSet: TDataSet);
var
  sSql  : String;
  dErRt : Double;
begin
  inherited;
  with DataSet do
  begin
  	if FieldByName('ACNT_TP').AsString = '2' then
    begin
      FieldByName('CMSN_TP_NGT').AsString   := FieldByName('CMSN_TP').AsString;
      FieldByName('CMSN_AMTRT_NGT').AsFloat := FieldByName('CMSN_AMTRT').AsFloat;
    end;

    if State in [dsEdit] then
    begin
      if (FieldByName('OVERNGT_YN').NewValue = 'N') and
         (FieldByName('OVERNGT_YN').OldValue <> FieldByName('OVERNGT_YN').NewValue) then
      begin
        sSql := Format('UPDATE OVERNGT SET OVERNGT_YN = %s WHERE ARTC_CD = %s',
                        [QuotedStr('N'),
                         QuotedStr(FieldByName('ARTC_CD').AsString)]);
        Uni_Open(MastDB.dbSQL, sSql);

      	bsMsgInfo('기존 오버나잇을 초기화 합니다.');
      end;
    end;
  end;

  Exit;
  //미니에서 사용안함
  with DataSet do
  begin
    if FieldByName('ACNT_TP').AsString = '2' then
    begin
      sSql := 'SELECT TOP(1) ER_RT '+
              'FROM EXCH_RT '+
              'ORDER BY TRADE_DT DESC, ER_TM DESC ';

      Uni_Open(dbPart, sSql);
      dErRt := dbPart.FieldByName('ER_RT').AsFloat;

      if FieldByName('CMSN_AMTRT_USD').OldValue <> FieldByName('CMSN_AMTRT_USD').NewValue then
      begin
        FieldByName('CMSN_AMTRT').AsFloat := TRUNC(FieldByName('CMSN_AMTRT_USD').AsFloat * dErRt);
      end;
      if FieldByName('TICK_VALUE_USD').OldValue <> FieldByName('TICK_VALUE_USD').NewValue then
      begin
        FieldByName('TICK_VALUE').AsFloat := TRUNC(FieldByName('TICK_VALUE_USD').AsFloat * dErRt);
      end;
    end;
  end;
end;

procedure TfmArtc.dbMainCalcFields(DataSet: TDataSet);
var
  iCnt : Integer;
begin
  inherited;
  with DataSet do
  begin
    iCnt := FieldByName('DOT_CNT').AsInteger;
    FieldByName('TICKSIZE').AsString  := FormatFloat(FormatDotCnt(iCnt), FieldByName('TICK_SIZE').AsFloat);
    FieldByName('TICKSIZELOW').AsString  := FormatFloat(FormatDotCnt(iCnt), FieldByName('TICK_SIZE_LOW').AsFloat);

    if FieldByName('CMSN_TP').AsString = 'A' then  FieldByName('CMSNTP').AsString := '금액'
    else if FieldByName('CMSN_TP').AsString = 'R' then FieldByName('CMSNTP').AsString := '율';

    if FieldByName('CMSN_TP_NGT').AsString = 'A' then  FieldByName('CMSNTP_NGT').AsString := '금액'
    else if FieldByName('CMSN_TP_NGT').AsString = 'R' then FieldByName('CMSNTP_NGT').AsString := '율';

  end;
end;

procedure TfmArtc.edArtcNMChange(Sender: TObject);
begin
  inherited;
  if edArtcNM.Text = '' then Exit;

  pnArtc.Caption := Format('품목명[%s]', [dbMain.FieldByName('ARTC_NM').AsString]);

end;

procedure TfmArtc.FormShow(Sender: TObject);
begin
  inherited;

  PartTableOpen(cbCmsnTp, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('CMSN_TP')]));
  PartTableOpen(cbCmsnTp_Ngt, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('CMSN_TP')]));

  PartTableOpen(cbOrdState, Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('ORD_STATE')]));
  PartTableOpen(TComponent(gdMain.Columns[2]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('ORD_STATE')]));
//  PartTableOpen(TComponent(gdMain.Columns[10]), Format('@|CODE_VALUE_NM, CODE_VALUE|CODE_MST|WHERE CODE_ID = %s ORDER BY CODE_VALUE', [QuotedStr('CMSN_TP')]));

  MainTableOpen;

end;

procedure TfmArtc.kcRzDBEdit1Change(Sender: TObject);
begin
	with dbMain do
  begin
    cbCmsnTp_Ngt.Enabled    := FieldByName('ACNT_TP').AsString = '1';
    edCmsnAmtrt_Ngt.Enabled := FieldByName('ACNT_TP').AsString = '1';
  end;
//미니에서 사용안함  edTickValue.ReadOnly := dbMain.FieldByName('ACNT_TP').AsString = '2';
//  edCmsnAmtrt.ReadOnly := dbMain.FieldByName('ACNT_TP').AsString = '2';

//  edTickValueUsd.Enabled := dbMain.FieldByName('ACNT_TP').AsString = '2';
//  edCmsnAmtrtUsd.Enabled := dbMain.FieldByName('ACNT_TP').AsString = '2';
end;

procedure TfmArtc.MainTableOpen;
var
  sSql : String;
begin
  try
    Delay_Show();

    sSql := 'SELECT          '+
            ' ARTC_CD        '+
            ',ARTC_NM        '+
            ',BS_TP          '+
            ',TICK_SIZE      '+
            ',TICK_SIZE_LOW  '+
            ',TICK_VALUE     '+
            ',TICK_VALUE_LOW '+
            ',TICK_VALUE_USD '+
            ',ARTC_USE_YN    '+
            ',DOT_CNT        '+
            ',API_CLTL       '+
            ',CMSN_TP        '+
            ',CMSN_AMTRT     '+
            ',CMSN_TP_NGT    '+
            ',CMSN_AMTRT_NGT '+
            ',CMSN_AMTRT_USD '+
            ',OVERNGT_YN     '+
            ',OVERNGT_AMT    '+
            ',GUJA_CNTR_CNT  '+
            ',LOSSCUT_AMT    '+
            ',MKT_TP         '+
            ',START_TM       '+
            ',END_TM         '+
            ',MTR_END_TM     '+
            ',NOTI_1_YN      '+
            ',NOTI_3_YN      '+
            ',NOTI_5_YN      '+
            ',NOTI_10_YN     '+
            ',MONTH_GAP      '+
            ',SAMEHOGA_AMT   '+
            ',ACNT_TP        '+
            ',ORD_STATE      '+
            'FROM ARTC_MST   ';
    Uni_Open(dbMain, sSql);
  finally
    Delay_Hide;
  end;
end;

end.
